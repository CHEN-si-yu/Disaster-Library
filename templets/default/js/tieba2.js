_.Module.define({path:"ucenter/widget/tbSpam",requires:[],sub:{initial:function(){$("body").append($("#tb_spam_notice_html").html())}}});_.Module.define({path:"frs/widget/WuxianRecommend",sub:{initial:function(){var a=this;$.JsLoadManager.use(["http://tieba.baidu.com/tb/cms/wuxianrecommend.js?v="+Math.random()],function(){a.fillData()})},fillData:function(){var b=wuxianRecommendData||{},a="";if(!b.url||b.url.length==0||b.src.length==0){return}a='<a class="recommend_ad" target="_blank" href="'+b.url+'"><img src="'+b.src+'" width="198" height="240" alt="'+b.alt+'"/></a>';$("#wuxian_recommend").addClass("recommend_theme_2").html(a)}}});_.Module.define({path:"frs/widget/ForumManager",requires:["frs/widget/ForumManager/BazhuSkinManager"],sub:{initial:function(f,e,d){var a=this;if(d!="album"){a.batchDeleteTip()}$(".tbBazhu").click(function(g){$.stats.sendRequest("st_mod=pv&fr=tb0_forum&st_type=bazhupage_from_forumManagerPannel")});var b=window.userSkinManager;if(b!=null){var c=null;$("#adminModePanel").find(".j_btn_skin_mgr").bind("click",function(){if(c==null){c=a.use("BazhuSkinManager",{skinId:(f.background["bg_id"]||null),fid:f.id,tbs:e.post_params["tbs"],fname:f.name,userSkinManager:b})}c.openDlg()})}},batchDeleteTip:function(){if($.cookie("not_show_batch_delete_tip")=="true"){return}var a=(new Date()-new Date("2013/02/09"))/86400000;if(a>=16||a<=0){return}$("#adminModePanel").css("position","relative");var c={content:$("#pageconf_forum_manager_skinbubble").html(),arrow_dir:"up",bubble_css:{top:80,right:100,width:117},arrow_pos:{left:30},attr:"",wrap:$("#adminModePanel"),closeBtn:true};var b=new UiBubbleTipBase(c);b.showBubble();b.bind("onclose",function(){$.cookie("not_show_batch_delete_tip",true,{expires:30,path:"/"})},true)}}});;_.Module.define({path:"frs/widget/ForumManager/BazhuSkinManager",requires:["frs/widget/ForumManager/SkinData","frs/widget/ForumManager/FrsSkinDlg"],sub:{_skinData:null,_skinDlg:null,_userSkinManager:null,initial:function(b){var a=this;this._skinData=this.use("SkinData",b);this._skinData.onSaved=function(c){a.afterSave(c)};this._userSkinManager=b.userSkinManager},_initDlg:function(){var a=this;var b=this.use("FrsSkinDlg","frs_skin_dlg",this._skinData);b.onSelectSkin=function(c){a._userSkinManager.setSkin(c)};b.onCancel=function(){var c=a._skinData.getSkinOriginal();a._userSkinManager.setSkin(c)};b.onOk=function(){var c=a._skinData.getSkinSelected();a._userSkinManager.resetSkin(c)};this._skinDlg=b},openDlg:function(){var a=this;if(this._skinDlg==null){this._loadData(function(){a._initDlg();a._skinDlg.show()})}else{this._skinDlg.show()}},_loadData:function(a){this._skinData.loadData(a)},closeDlg:function(){if(this._skinDlg!=null){this._skinDlg.hide()}},afterSave:function(a){if(a){this._showSaveResult(a)}},_showSaveResult:function(a){var b='<div class="skin_success_dlg"><div class="skin_success_dlg_l1">\u4fdd\u5b58\u6210\u529f</div><div class="skin_success_dlg_l2">\u672c\u7a97\u53e3\u57283\u79d2\u540e\u81ea\u52a8\u5173\u95ed</div></div>';var c=new $.dialog({html:b,title:"\u80cc\u666f\u8bbe\u7f6e",width:300});setTimeout(function(){c.close()},3000)}}});;_.Module.define({path:"frs/widget/ForumManager/FrsSkinDlg",sub:{_id:"",_skinData:null,_dlgInstance:null,_tabCapacity:8,_status:0,initial:function(b,a){this._id=b;this._skinData=a;this._dlgInstance=this._initDlgInstance();this.restoreDlg();this.bindEvents()},_initDlgInstance:function(){var a=this._createDlgHtml();var b=null;b=new $.dialog({html:a,title:"\u80cc\u666f\u8bbe\u7f6e",showShadow:false,width:498,hideOnclose:true,show:false});return b},_createDlgHtml:function(){var a=['<div id="',this._id,'" class="skindlg">',this._createTabNavHtml(),'<ul class="skindlg_skinshelf j_skindlg_skinshelf"></ul>','<ul class="skindlg_pager j_skindlg_pager"></ul>','<div class="skindlg_btns"><input class="skindlg_btnok j_skindlg_btnok" type="button" value="\u4fdd&nbsp;\u5b58"/><input class="skindlg_btncl j_skindlg_btncl" type="button" value="\u53d6&nbsp;\u6d88"/></div>',"</div>"];return a.join("")},_createTabNavHtml:function(){var a=['<ul class="skindlg_nav j_skindlg_nav">'];var c=this._skinData.getSkinDataConfig();for(var d=0,b=c.length;d<b;d++){a.push("<li tabidx=");a.push(d);a.push('><a href="#" onclick="return false;" tabidx=');a.push(d);a.push(">");a.push(c[d]["groupName"]);a.push("</a></li>")}a.push("</ul>");return a.join("")},_createTabContenHtml:function(g,c){var k=[];var j=this._skinData.getSkinDataConfig()[g]["skinList"];var b=(c-1)*this._tabCapacity;var e=b+this._tabCapacity;e=e>j.length?j.length:e;for(var h=b;h<e;h++){var d=j[h]["skinId"];var a=j[h]["skinName"];var f=this._skinData.getSkinCover(d);k.push('<li><a style="background:url(');k.push(f);k.push(')" href="#" onclick="return false" bid="');k.push(d);k.push('"><span class="skindlg_skinmask"></span><span class="skindlg_skintitle">');k.push(a);k.push("</span></a></li>")}return k.join("")},_createPagerContentHtml:function(f,c){var e=this._skinData.getSkinDataConfig()[f]["skinList"];var g=this._tabCapacity;var b=Math.ceil(e.length/g);if(e.length>g){if(c==1){var a=['<li>\u4e0a\u4e00\u9875</li><li class="skindlg_pager_disable">1</li>'];for(var d=2;d<=b;d++){a.push("<li tabidx="+f+'><a href="#" onclick="return false" tabidx='+f+" pn="+d+">"+d+"</a></li>")}a.push("<li tabidx="+f+'><a href="#" onclick="return false" tabidx='+f+" pn="+(c+1)+">\u4e0b\u4e00\u9875</a></li>")}else{if(c==b){var a=["<li tabidx="+f+'><a href="#" onclick="return false" tabidx='+f+" pn="+(c-1)+">\u4e0a\u4e00\u9875</a></li>"];for(var d=1;d<=b-1;d++){a.push("<li tabidx="+f+'><a href="#" onclick="return false" tabidx='+f+" pn="+d+">"+d+"</a></li>")}a.push('<li class="skindlg_pager_disable">'+b+"</li><li>\u4e0b\u4e00\u9875</li>")}else{var a=["<li tabidx="+f+'><a href="#" onclick="return false" tabidx='+f+" pn="+(c-1)+">\u4e0a\u4e00\u9875</a></li>"];for(var d=1;d<=b;d++){if(d==c){a.push('<li class="skindlg_pager_disable">'+d+"</li>")}else{a.push("<li tabidx="+f+'><a href="#" onclick="return false" tabidx='+f+" pn="+d+">"+d+"</a></li>")}}a.push("<li tabidx="+f+'><a href="#" onclick="return false" tabidx='+f+" pn="+(c+1)+">\u4e0b\u4e00\u9875</a></li>")}}}else{var a=[""]}return a.join("")},showTab:function(d,c){var b=this._createTabContenHtml(d,c);var a=$("#"+this._id);a.find(".j_skindlg_skinshelf").tb_html(b);this.focusSkinCover(this._skinData.getSkinSelected());a.find(".j_skindlg_nav li").each(function(){var e=$(this);e.toggleClass("focus",e.attr("tabidx")==d?true:false)})},showPager:function(d,b){var c=this._createPagerContentHtml(d,b);var a=$("#"+this._id);a.find(".j_skindlg_pager").tb_html(c)},focusSkinCover:function(a){$("#"+this._id).find(".j_skindlg_skinshelf a").each(function(){var b=$(this);b.toggleClass("focus",b.attr("bid")==a?true:false)})},restoreDlg:function(){var a=0;this.showTab(a,1);this.showPager(a,1)},bindEvents:function(){var b=this;var a=$("#"+this._id);var c=a.find(".j_skindlg_btnok");var d=a.find(".j_skindlg_btncl");a.delegate(".j_skindlg_nav a","click",function(){b.showTab($(this).attr("tabidx"),1);b.showPager($(this).attr("tabidx"),1)});a.delegate(".j_skindlg_skinshelf a","click",function(){var e=$(this).attr("bid");b.focusSkinCover(e);if(!b.onSelectSkin(e)){b._skinData.setSkinSelected(e)}});a.delegate(".j_skindlg_pager a","click",function(){var e=$(this).attr("tabidx");var f=parseInt($(this).attr("pn"));b.showTab(e,f);b.showPager(e,f)});c.bind("click",function(){if(!b.onOk()){b._skinData.save();b.hide(1)}});d.bind("click",function(){b.hide(0)});this._setBtnEffect(c,"skindlg_btnok");this._setBtnEffect(d,"skindlg_btncl");this._dlgInstance.bind("onhide",function(){if(b._status==0){b._cancel()}b._status=0})},_setBtnEffect:function(d,a){var b=[a,a+"_hover",a+"_active"];var c=b.join(" ");d.mouseover(function(){d.removeClass(c).addClass(b[1])});d.mouseout(function(){d.removeClass(c).addClass(b[0])});d.mousedown(function(){d.removeClass(c).addClass(b[2])})},_cancel:function(){if(!this.onCancel()){this._skinData.restore();this.restoreDlg()}},show:function(){this._dlgInstance.show()},hide:function(a){self._status=a;this._dlgInstance.hide()},onSelectSkin:function(a){},onOk:function(){},onCancel:function(){}}});;_.Module.define({path:"frs/widget/ForumManager/SkinData",sub:{_skinOriginal:null,_skinSelected:null,_skinDataConfig:null,_saveUrl:"/frsbgcui/frsbgcui",_getSkinDataUrl:"/frsbgcui/getfrsbg",_postData:{},_loadParam:{},initial:function(a){this._skinOriginal=a.skinId;this._skinSelected=this._skinOriginal;this._postData={fid:a.fid,fname:a.fname,tbs:a.tbs};this._loadParam={fid:a.fid,fname:a.fname,ie:"utf-8"};return this},onSaved:function(a){},onDataLoaded:function(){},save:function(){var b=this;var a=$.extend({bgid:this._skinSelected},this._postData);b._skinOriginal=b._skinSelected;$.tb.post(b._saveUrl,a,function(c){if(c&&c.no==0){b.onSaved(true)}else{b.onSaved(false)}})},setSkinSelected:function(a){this._skinSelected=a},getSkinSelected:function(){return this._skinSelected},getSkinOriginal:function(){return this._skinOriginal},restore:function(){this._skinSelected=this._skinOriginal},getSkinDataConfig:function(){return this._skinDataConfig},getSkinCover:function(a){return["http://tb2.bdstatic.com/tb/cms/frs/bg/bg_",a,"_thum.jpg?v=1"].join("")},_getSkinData:function(){var a=this;$.getJSON(this._getSkinDataUrl,this._loadParam,function(b){a._skinDataConfig=b.data.skinData;a.onDataLoaded()})},loadData:function(a){if(a!=null){this.onDataLoaded=a}this._getSkinData()}}});;_.Module.define({path:"frs/widget/ThreadBatchDelete",requires:[],sub:{hasDom:false,initial:function(){var a=this;$(".j_btn_batch_delete").click(function(){a.switchMode()});if($.cookie("batch_delete_mode")=="true"){$(".j_btn_batch_delete").click()}$(document).bind("listReload",function(){if($.cookie("batch_delete_mode")=="true"){a.initStatus();a.switchMode()}else{a.initStatus()}})},initStatus:function(){var a=this;a.hasDom=false;$(".j_batch_delete").remove();$(".j_batch_delete_btn_area").remove();$(".j_btn_batch_delete span").html("\u8fdb\u5165\u7ba1\u7406\u6a21\u5f0f");$(".th_footer_2").show()},createChooseNode:function(){var a=this;a.hasDom=true;$(".j_thread_list").each(function(b,c){var d=$.parseJSON($(c).attr("data-field"));if((d.reply_num>10000000)||(d.is_good==1)||(d.is_bakan==1)||(d.is_protal==1)){}else{$(c).append("<div class='batch_delete j_batch_delete'><div class='batch_delete_text'>\u52fe\u9009</div><input type='checkbox' class='batch_delete_select j_batch_delete_select'/></div>")}});$(".th_footer_2").after("<div class='batch_delete_btn_area j_batch_delete_btn_area clearfix'><div class='deleteAndBan j_deleteAndBan'>\u5220\u9664\u5e76\u5c01\u7981\u697c\u4e3b\u4e00\u5929</div><div type='button' class='deleteThreads j_deleteThreads'>\u5220\u9664</div></div>");$(".th_footer_2").hide();$(".j_deleteThreads").click(function(){a.deleteThread(0)});$(".j_deleteAndBan").click(function(){a.deleteThread(1)})},switchMode:function(){var a=this;var b=$(".j_btn_batch_delete span");if(b.html()=="\u8fdb\u5165\u7ba1\u7406\u6a21\u5f0f"){b.html("\u8fd4\u56de\u666e\u901a\u6a21\u5f0f");a.intoDeleteMode()}else{b.html("\u8fdb\u5165\u7ba1\u7406\u6a21\u5f0f");a.intoNormalMode()}},intoDeleteMode:function(){var a=this;if(a.hasDom){$(".j_batch_delete").show();$(".j_batch_delete_btn_area").show();$(".th_footer_2").hide()}else{a.createChooseNode()}$.cookie("batch_delete_mode",true,{expires:30,path:"/"})},intoNormalMode:function(){$(".j_batch_delete").hide();$(".j_batch_delete_btn_area").hide();$(".th_footer_2").show();$.cookie("batch_delete_mode",false,{expires:30,path:"/"})},deleteThread:function(c){var b="";$(".j_batch_delete_select:checked").each(function(d,e){var f=$(e).parent().parent().attr("data-field");if(d==0){b=$.parseJSON(f).id}else{b=b+"_"+$.parseJSON(f).id}});var a={fid:PageData.forum.id,tbs:PageData.tbs,tid:b,kw:PageData.forum.name,isBan:c};if(b!=""){$.tb.post("/f/commit/thread/batchDelete",a,function(d){if(d.no==0){window.location.reload()}else{if(d.no==12){$.dialog.alert("<p>\u62b1\u6b49\uff0c\u8d26\u53f7\u5904\u4e8e\u5c01\u7981\u72b6\u6001\uff0c\u6682\u65f6\u4e0d\u80fd\u5220\u8d34\u3002<a href='http://tieba.baidu.com/upc/userinfo?fid="+PageData.forum.id+"' target='_blank'>\u70b9\u51fb\u6b64\u5904</a>\u67e5\u770b\u8be6\u7ec6\u4fe1\u606f</p>")}else{if(d.no==13){$.dialog.alert("<p>\u62b1\u6b49\uff0c\u7f51\u7edc\u5730\u5740\u5904\u4e8e\u5c01\u7981\u72b6\u6001\uff0c\u6682\u65f6\u4e0d\u80fd\u5220\u8d34\u3002<a href='http://tieba.baidu.com/upc/userinfo?fid="+PageData.forum.id+"' target='_blank'>\u70b9\u51fb\u6b64\u5904</a>\u67e5\u770b\u8be6\u7ec6\u4fe1\u606f</p>")}else{if(d.error==""){$.dialog.alert("\u51fa\u9519\u5566\uff0c\u5237\u65b0\u9875\u9762\u770b\u4e0b\u5427\u3002")}else{$.dialog.alert(d.error)}}}}})}}}});_.Module.define({path:"frs/widget/ForumInfo",requires:["frs/widget/ForumInfo/ForumInfoManager"],sub:{initial:function(f,d,h,e){var b=this.use("ForumInfoManager",e);var c=$("#"+f);if(!c.length){return}var g;var a;g=c.find(".manager_btn:first");a=c.find(".member_setup:first");if(g.length){g.click(function(){b.showForumTeamList();return false})}if(a.length){a.click(function(){b.setMemberName();return false})}if(d<3){$(window).bind("load",function(){b.displayApplyInfo(h)})}}}});_.Module.define({path:"frs/widget/Bakan",sub:{bakan_dialog:null,bool_reload:null,initial:function(e){var b=this;var c=$("#"+e);if(!c.length){return}var a,d;a=c.find(".setup_btn:first");d=c.find(".bakan_pic");if(a.length){a.click(function(){b.setModeName();return false})}if(d.length&&d.attr("isrc")){d.bind("load",function(){$.resizePic(d,60,80)});d.attr("src",d.attr("isrc"))}},setModeName:function(){var a=this;var b='<div style="padding-left:15px; padding-top:20px">';b+=("<div style='height:35px;'><form onsubmit='frs.Bakan.commitMode();return false;'><strong>\u6a21\u5757\u540d\u79f0</strong>\uff1a<span id='bakan_mode_modify'><span id='name_show'>#{name}</span>&nbsp;&nbsp;&nbsp;&nbsp;<img src='"+PageData.staticDomain+"static/tb/img/edit.gif' width='15' height='16'><a href='' onclick='frs.Bakan.editMode();return false;'>\u7f16\u8f91</a><br><br></span></form></div><br><a href='/bakan/set?kw=#{word}' target='about:blank' onclick='javascript:if(frs.Bakan.bakan_dialog) frs.Bakan.bakan_dialog.close();' style='font-family:\u5b8b\u4f53'>\u5bf9\u672c\u5427\u5427\u520a\u8fdb\u884c\u66f4\u591a\u8bbe\u7f6e&gt;&gt;</a>").tempFormat({name:PageData.bakan_mod.mod_name,word:PageData.forum.name_url});b+="</div>";this.bakan_dialog=$.dialog.open(b,{title:"\u8bbe\u7f6e",width:400,height:120});this.bool_reload=false;this.bakan_dialog.bind("onclose",function(){if(a.bool_reload){location.reload(true)}})},editMode:function(){var a=('<input type="text" value="#{name}" id="name_edit">&nbsp;<input type="submit" value="\u786e\u5b9a">&nbsp;<a onclick="frs.Bakan.cancalMode();return false;" href="#">\u53d6\u6d88</a><br><span id="name_edit_tip" style="margin-left: 64px;">\u4ec5\u9650\u4f7f\u7528\u6c49\u5b57\u3001\u5b57\u6bcd\u3001\u6570\u5b57\u548c\u4e0b\u5212\u7ebf</span>').tempFormat({name:PageData.bakan_mod.mod_name});$("#bakan_mode_modify").html(a)},cancalMode:function(){var a=("<span id='name_show'>#{name}</span>&nbsp;&nbsp;&nbsp;&nbsp;<img src='"+PageData.staticDomain+"static/tb/img/edit.gif' width='15' height='16'><a href='' onclick='frs.Bakan.editMode();return false;'>\u7f16\u8f91</a><br><br>").tempFormat({name:PageData.bakan_mod.mod_name,g_forumName_url:"url",g_bdForumID:"id"});$("#bakan_mode_modify").html(a)},commitMode:function(){var a=this;var b="/bakan/commit/modify_module_name";var c=$("#name_edit").val();var d={ie:"utf-8",kw:PageData.forum.name,module_name:c,tbs:PageData.base.tbs};$.ajax({type:"POST",url:b,data:d,success:function(g){var f=$.json.decode(g);$("#name_edit_tip").html("\u4ec5\u9650\u4f7f\u7528\u6c49\u5b57\u3001\u5b57\u6bcd\u3001\u6570\u5b57\u548c\u4e0b\u5212\u7ebf");if(f.error_no==0){var e=("<span id='name_show'>#{name}</span>&nbsp;&nbsp;&nbsp;&nbsp;<img src='"+PageData.staticDomain+"static/tb/img/edit.gif' width='15' height='16'><a href='' onclick='frs.Bakan.editMode();return false;'>\u7f16\u8f91</a><br><br>").tempFormat({name:c,g_forumName_url:"url",g_bdForumID:"id"});$("#bakan_mode_modify").html(e);PageData.bakan_mod.mod_name=c;a.bool_reload=true}else{$("#name_edit_tip").html("<font color=red>"+f.error_info+"</font>");a.bool_reload=false}}})}}});_.Module.define({path:"frs/widget/Zyq",sub:{initial:function(){if($("#zyq_mod_album").length){this.album("zyq_mod_album")}if($("#zyq_mod_video").length){this.video("zyq_mod_video")}if($("#mod_stock").length){this.stock("mod_stock")}},album:function(c){var b=$("#"+c);if(!b.length){reutrn}if(PageData.forum.album_forum||PageData.forum.album_good_smallflow){b.hide()}var a=b.find(".alb_box_inner img:first");if(a.length&&a.attr("isrc")){a.bind("load",function(){resizePic_temp(this,133,170)});a.attr("src",a.attr("isrc"))}},video:function(b){if(!b||!$("#"+b).length){return}var c=$("#"+b).attr("video-num");if(c<=0){return}var a={ITEMWiDTH:120,FRAMEHWIDTH:140,SPACHEWIDTH:10,_leftPadding:0,scroll:function(){var f=document.getElementById("scrollCt");var e=document.getElementById("itemsCt");if(!f||!e){return}var d=parseInt(e.offsetWidth);var g=function(){if(a._leftPadding<=-d+a.FRAMEHWIDTH-5){a._leftPadding=0;f.style.left=a._leftPadding+"px"}else{a._leftPadding=a._leftPadding-2;f.style.left=a._leftPadding+"px"}};if(d+10>=(a.ITEMWiDTH+a.SPACHEWIDTH)*2){timer=setInterval(g,120)}}};$(window).bind("load",a.scroll)},stock:function(a){if(!a||!$("#"+a).length){return}$.JsLoadManager.use("http://tb1.bdstatic.com/tb/static-zyq/js/mod/zyq_mod_frs_stock.js?v=2011.05.31",function(){$("#j_zyq_stock").bind("click",function(){changeToKChart();Common.statistic(11)})})}}});_.Module.define({path:"album/widget/entryFrsDiscuss",requires:[],sub:{jqContainer:null,initial:function(a){this.jqContainer=$("#"+a);this.bindEvents()},bindEvents:function(){this.jqContainer.on("mousedown","a",function(){$.stats.sendRequest("fr=tb0_forum&page=new_version&st_mod=album_new&st_type=frs_discuss&st_value=album_good_thread")})}}});window.Common_GoTop=function(e){var c=false,b={id:"goTop","class":"goTop goTop_self",href:"#"},d="<style>html{_background:url(about:blank) fixed;}</style>";if($.browser.msie&&$.browser.version<7){b["class"]+=" goTop_ie6";$("body").append(d)}$("<a>").attr(b).bind("click",function(){Common_ToTop(e);return false}).appendTo("body");var f=$("#goTop");var a=$("#container").offset().left-f.width()-5;if(a<0){f.addClass("goTop_1024")}var g;setTimeout(function(){$(window).bind("scroll",function(){if(g){clearTimeout(g)}g=setTimeout(function(){if($(window).scrollTop()>0){if(!c){f.fadeIn(500);c=true}}else{if(c){f.fadeOut();c=false}}},500)})},500)};window.Common_ToTop=function(b){var d=null;var c=$(window).scrollTop();if($.browser.msie||b){window.scrollTo(0,0)}else{function a(){c=Math.floor(c/2);window.scrollTo(0,c);if(c>2){d=setTimeout(a,40)}else{window.scrollTo(0,0);clearTimeout(d)}}a()}};function Sketchpad(a,b){this.init(a,$.extend({},Sketchpad.defaultOptions,b))}Sketchpad.template='<canvas class="sketchpad_bg"></canvas>     <canvas class="sketchpad_result"></canvas>     <canvas class="sketchpad_mask"></canvas>     <textarea class="sketchpad_text_input" style="display: none;"></textarea>';Sketchpad.defaultOptions={width:400,height:300,fixCanvas:false,onhistorychange:function(){}};Sketchpad.prototype={init:function(a,c){var b=this;this.element=$(a);var d=$(Sketchpad.template);d.filter("canvas").each(function(){this.width=c.width;this.height=c.height});this.element.addClass("sketchpad").css({width:c.width,height:c.height}).append(d);this.fixCanvas=c.fixCanvas;this.history=[];this.onhistorychange=c.onhistorychange;this.redoStack=[];this.clearState=false;this.bgCanvas=this.element.find(".sketchpad_bg");this.bgContext=this.bgCanvas[0].getContext("2d");this.mouseDownHandler=this._mouseDownLineHandler;this.mouseUpHandler=this._mouseUpLineHandler;this.mouseMoveHandler=this._mouseMoveLineHandler;this.initCanvas();this.initTextInput();this.currentCommand=null;this.setPaintType("brush");this.setPaintShape("rect");this.setLineWidth(3);this.setPaintColor("black");this.setPaintFontSize(12);this.refreshPosition();this.element.on("dragover",function(f){f.preventDefault();f.stopPropagation()});this.element[0].addEventListener("drop",function(h){h.preventDefault();h.stopPropagation();var g=h.dataTransfer.files[0];var f=new FileReader();f.onload=function(j){var i=new Image();i.onload=function(){b.setBackgroundImage(i)};i.src=j.target.result};f.readAsDataURL(g)})},initTextInput:function(){this.textInput=this.element.find(".sketchpad_text_input")},initCanvas:function(){var a=this;this.resultCanvas=this.element.find(".sketchpad_result");this.resultContext=this.resultCanvas[0].getContext("2d");this.maskCanvas=this.element.find(".sketchpad_mask");this.maskContext=this.maskCanvas[0].getContext("2d");this.maskCanvas.on("click",function(f){if(a.paintType=="text"){if(!a.textDrawing){a.textDrawing=true;var e=f.clientX-a.offset.left+(window.pageXOffset||document.body.scrollLeft||document.documentElement.scrollLeft);var j=f.clientY-a.offset.top+(window.pageYOffset||document.body.scrollTop||document.documentElement.scrollTop);a.textInput.css({left:e,top:j}).show().focus()}else{a.textDrawing=false;var h=a.textInput.val();if(h.length>0){var d=a.textInput[0].offsetLeft+1;var i=a.textInput[0].offsetTop;var g=a.drawText(a.resultContext,h,d,i,a.textInput.innerWidth());a._pushHistory(g);a.textInput.val("")}a.textInput.hide()}}});this.maskCanvas.on("mousedown",function(d){d.preventDefault();a.mouseDownHandler(d)});var b=function(d){a.mouseUpHandler(d)};var c=function(d){a.mouseMoveHandler(d)};$(document).on("mouseup",b).on("mousemove",c);a.clearEvents=function(){$(document).unbind("mouseup",b).unbind("mousemove",c)}},_mouseDownLineHandler:function(b){var a=this;a.drawing=true;a.iLastX=b.clientX-a.offset.left+(window.pageXOffset||document.body.scrollLeft||document.documentElement.scrollLeft);a.iLastY=b.clientY-a.offset.top+(window.pageYOffset||document.body.scrollTop||document.documentElement.scrollTop);a.drawPoint(a.resultContext,a.iLastX,a.iLastY,a.lineWidth);if(a.currentCommand==null){a.currentCommand={type:"brush",path:[],color:a.paintColor,lineWidth:a.lineWidth,clearState:a.clearState,startPoint:{x:a.iLastX,y:a.iLastY,diameter:a.lineWidth}}}},_mouseMoveLineHandler:function(c){var b=this;if(b.drawing){var a=c.clientX-b.offset.left+(window.pageXOffset||document.body.scrollLeft||document.documentElement.scrollLeft);var e=c.clientY-b.offset.top+(window.pageYOffset||document.body.scrollTop||document.documentElement.scrollTop);var d={fromX:b.iLastX,fromY:b.iLastY,toX:a,toY:e};b.drawLine(b.resultContext,d);b.currentCommand.path.push(d);b.iLastX=a;b.iLastY=e}},_mouseUpLineHandler:function(b){var a=this;if(a.drawing){a.drawing=false;a.iLastX=-1;a.iLastY=-1;a._pushHistory(a.currentCommand);a.currentCommand=null}},_mouseDownShapeHandler:function(b){var a=this;a.drawing=true;a.iLastX=b.clientX-a.offset.left+(window.pageXOffset||document.body.scrollLeft||document.documentElement.scrollLeft);a.iLastY=b.clientY-a.offset.top+(window.pageYOffset||document.body.scrollTop||document.documentElement.scrollTop)},_mouseMoveShapeHandler:function(c){var b=this;if(b.drawing){b._clear(b.maskContext);var a=c.clientX-b.offset.left+(window.pageXOffset||document.body.scrollLeft||document.documentElement.scrollLeft);var d=c.clientY-b.offset.top+(window.pageYOffset||document.body.scrollTop||document.documentElement.scrollTop);b.currentCommand=b.drawShape(b.maskContext,b.iLastX,b.iLastY,a-b.iLastX,d-b.iLastY)}},_mouseUpShapeHandler:function(b){var a=this;if(a.drawing){a.drawing=false;a.iLastX=-1;a.iLastY=-1;a._clear(a.maskContext);if(a.currentCommand){a.doCommand(a.currentCommand);a._pushHistory(a.currentCommand);a.currentCommand=null}}},_mouseDownTextHandler:function(){},_mouseMoveTextHandler:function(){},_mouseUpTextHandler:function(){},_pushHistory:function(a){this.history.push(a);this.onhistorychange(this.history,this.redoStack)},drawLine:function(a,b){a.beginPath();a.moveTo(b.fromX,b.fromY);a.lineTo(b.toX,b.toY);a.stroke()},drawPoint:function(b,a,d,c){b.beginPath();b.arc(a,d,c/2,0,Math.PI*2,true);b.closePath();b.fill()},drawPath:function(c,f){var d=f.startPoint;this.drawPoint(c,d.x,d.y,d.diameter);var e=f.path;for(var b=0,a=e.length;b<a;b++){this.drawLine(c,e[b])}},drawRect:function(c,a,e,b,d){c.strokeRect(a,e,b,d);return{type:"shape",shape:"rect",x:a,y:e,width:b,height:d,color:this.paintColor,lineWidth:this.lineWidth}},drawEllipse:function(m,j,i,k,d){var g=0.5522848;var c=(k/2)*g,a=(d/2)*g,l=j+k,f=i+d,e=j+k/2,b=i+d/2;m.beginPath();m.moveTo(j,b);m.bezierCurveTo(j,b-a,e-c,i,e,i);m.bezierCurveTo(e+c,i,l,b-a,l,b);m.bezierCurveTo(l,b+a,e+c,f,e,f);m.bezierCurveTo(e-c,f,j,b+a,j,b);m.closePath();m.stroke();return{type:"shape",shape:"ellipse",x:j,y:i,width:k,height:d,color:this.paintColor,lineWidth:this.lineWidth}},drawText:function(p,m,i,h,k,r){r=r||this.fontSize;var g=m.split("");var j=r*1.2;var e=h;e+=r;for(var b=0,c=g.length,q="";b<c;b++){var a=g[b];if(a=="\n"){p.fillText(q,i,e);q="";e+=j}else{var d=q+a;var f=p.measureText(d);var o=f.width;if(o>k){p.fillText(q,i,e);q=a;e+=j}else{q=d}}}p.fillText(q,i,e);return{type:"text",x:i,y:h,text:m,maxWidth:k,color:this.paintColor,fontSize:r}},setPaintType:function(a){this.paintType=a;if(a=="shape"){this.mouseDownHandler=this._mouseDownShapeHandler;this.mouseUpHandler=this._mouseUpShapeHandler;this.mouseMoveHandler=this._mouseMoveShapeHandler}else{if(a=="brush"){this.mouseDownHandler=this._mouseDownLineHandler;this.mouseUpHandler=this._mouseUpLineHandler;this.mouseMoveHandler=this._mouseMoveLineHandler}else{this.mouseDownHandler=this._mouseDownTextHandler;this.mouseUpHandler=this._mouseUpTextHandler;this.mouseMoveHandler=this._mouseMoveTextHandler}}if(a=="text"){this.element.css("cursor","text")}else{this.element.css("cursor","crosshair")}},setClear:function(a){this.clearState=a;if(a){this.resultContext.globalCompositeOperation="destination-out"}else{this.resultContext.globalCompositeOperation="source-over"}},_setPaintColor:function(a){this.resultContext.strokeStyle=a;this.maskContext.strokeStyle=a;this.resultContext.fillStyle=a;this.maskContext.fillStyle=a;this.textInput.css("color",a)},setPaintColor:function(a){this._setPaintColor(a);this.paintColor=a},_setLineWidth:function(a){this.resultContext.lineWidth=a;this.maskContext.lineWidth=a;this.resultContext.lineCap="round";this.maskContext.lineCap="round"},setLineWidth:function(a){this._setLineWidth(a);this.lineWidth=a},setPaintShape:function(a){if(a=="rect"){this.drawShape=this.drawRect}else{if(a=="ellipse"){this.drawShape=this.drawEllipse}}},setBackgroundImage:function(c){if(this.fixCanvas){var b=this.width/this.height;var d=null;var a=0,e=0;if(c.width>this.width||c.height>this.height){if((c.width/c.height)>b){d=c.width/this.width;c.width=this.width;c.height=c.height/d}else{d=c.height/this.height;c.height=this.height;c.width=c.width/d}}a=(this.width-c.width)/2;e=(this.height-c.height)/2;this._clear(this.bgContext);this.bgContext.drawImage(c,a,e,c.width,c.height)}else{this.bgCanvas.attr({width:c.width,height:c.height});this.resultCanvas.attr({width:c.width,height:c.height});this.maskCanvas.attr({width:c.width,height:c.height});this.element.css({width:c.width,height:c.height});this.width=c.width;this.height=c.height;this.bgContext.drawImage(c,0,0)}this.setPaintColor(this.paintColor);this.setLineWidth(this.lineWidth);this.setPaintFontSize(this.fontSize)},removeBackgroundImage:function(){this._clear(this.bgContext)},_setPaintFontSize:function(a){this.resultContext.font=a+"px '\u5b8b\u4f53'";this.textInput.css("fontSize",a)},setPaintFontSize:function(a){this._setPaintFontSize(a);this.fontSize=a},doCommand:function(a){this.resultContext.save();this.resultContext.strokeStyle=a.color;this.resultContext.fillStyle=a.color;if(a.type=="text"){this.resultContext.font=a.fontSize+"px '\u5b8b\u4f53'"}else{this.resultContext.lineWidth=a.lineWidth}if(a.type=="shape"&&a.shape=="rect"){this.resultContext.strokeRect(a.x,a.y,a.width,a.height)}else{if(a.type=="shape"&&a.shape=="ellipse"){this.drawEllipse(this.resultContext,a.x,a.y,a.width,a.height)}else{if(a.type=="text"){this.drawText(this.resultContext,a.text,a.x,a.y,a.maxWidth,a.fontSize)}else{if(a.type=="brush"){if(a.clearState){this.resultContext.globalCompositeOperation="destination-out"}else{this.resultContext.globalCompositeOperation="source-over"}this.drawPath(this.resultContext,a)}}}}this.resultContext.restore()},_clear:function(a){a.clearRect(0,0,this.width,this.height)},clear:function(){this._clear(this.resultContext);this.history.length=0;this.redoStack.length=0;this.onhistorychange(this.history,this.redoStack)},undo:function(){this._clear(this.resultContext);this.redoStack.push(this.history.pop());this.onhistorychange(this.history,this.redoStack);for(var b=0,a=this.history.length;b<a;b++){this.doCommand(this.history[b])}},redo:function(){var a=this.redoStack.pop();if(a!=null){this.doCommand(a);this._pushHistory(a)}},destroy:function(){this.clearEvents();this.element.html("")},refreshPosition:function(){this.offset=this.resultCanvas.offset();this.width=this.resultCanvas.width();this.height=this.resultCanvas.height()},getResult:function(a){a=a||"image/png";return this.resultCanvas[0].toDataURL(a)},_dataURLtoBlob:function(d,h){var c=atob(d.split(",")[1]);var b=d.split(",")[0].split(":")[1].split(";")[0];var j=new ArrayBuffer(c.length);var a=new Uint8Array(j);for(var e=0;e<c.length;e++){a[e]=c.charCodeAt(e)}var f=(window.MozBlobBuilder||window.WebKitBlobBuilder||window.BlobBuilder);if(f){var g=new f();g.append(j);return g.getBlob(b)}else{if(Blob){return new Blob([j],{type:b})}else{return null}}},getResultAsBlob:function(a){a=a||"image/png";return this._dataURLtoBlob(this.getResult(),a)}};function PicassoPanel(a,b){this.init(a);this.overlay=b}PicassoPanel.prototype={init:function(b){var c=this;c.container=$(b);c.container.html(PicassoPanel.template);c.currentColor="#ED2329";c.brushType="brush";var a=c.container.find(".tb_picasso_content");this.sketchpad=new Sketchpad(a,{fixCanvas:true,onhistorychange:function(e,d){if(e.length==0){c.undoButton.prop("disabled",true);c.clearButton.prop("disabled",true)}else{c.undoButton.prop("disabled",false);c.clearButton.prop("disabled",false)}if(d.length==0){c.redoButton.prop("disabled",true)}else{c.redoButton.prop("disabled",false)}}});this.sketchpad.setPaintColor("#ED2329");c.container.find(".color_panel").on("click","div",function(){var d=this.style.backgroundColor;$(this).parent().siblings(".focus").removeClass("focus").end().addClass("focus");c.currentColor=d;if(c.brushType=="brush"){c.sketchpad.setPaintColor(d)}});c.brushButtons=c.container.find(".brush_button");c.brushButtons.click(function(){c.brushButtons.filter(".focus").removeClass("focus");var d=$(this).addClass("focus");var f=d.data("brushType");var e=d.text()-0;c.sketchpad.setLineWidth(e);if(f=="eraser"){c.sketchpad.setClear(true);c.sketchpad.setPaintColor("black")}else{c.sketchpad.setClear(false);c.sketchpad.setLineWidth(e);c.sketchpad.setPaintColor(c.currentColor)}c.brushType=f});c.deleteBgButton=c.container.find(".sketchpad_remove_bg").click(function(){c.sketchpad.removeBackgroundImage();c.deleteBgButton.addClass("disabled")});c.undoButton=c.container.find(".sketchpad_undo").click(function(){c.sketchpad.undo()});c.redoButton=c.container.find(".sketchpad_redo").click(function(){c.sketchpad.redo()});c.clearButton=c.container.find(".sketchpad_clear").click(function(){c.sketchpad.clear()});c.container.find(".sketchpad_finish").click(function(){if(c.sketchpad.history.length==0){c.messagePanel.show();return}var g=c.container.find(".sketchpad_sign")[0];var e=g.getContext("2d");e.fillStyle="#EEEEEE";e.fillRect(0,0,416,335);e.fillStyle="#FFFFFF";e.fillRect(8,8,400,300);e.drawImage(c.sketchpad.bgCanvas[0],8,8,400,300);e.drawImage(c.sketchpad.resultCanvas[0],8,8,400,300);var d="By "+PageData.user.name;var f=e.measureText(d);e.font="12px '\u5b8b\u4f53'";e.fillStyle="black";e.fillText(d,400-f.width,325);e.fillText("\u8d34\u5427\u6d82\u9e26",8,325);c._uploadImage(g)});c.container.find(".sketchpad_image_input").change(function(){var f=this;if(f.files.length>0){var e=f.files[0];if(/^image/.test(e.type)){var d=new FileReader();d.onload=function(h){var g=new Image();g.onload=function(){c.sketchpad.setBackgroundImage(g);c.deleteBgButton.removeClass("disabled")};g.src=h.target.result};d.readAsDataURL(e)}}});c.messagePanel=c.container.find(".picasso_message");c.messagePanel.find(".picasso_message_apply").click(function(){c.messagePanel.hide()});if(!window.FlashImageLoader){$.JsLoadManager.use("http://static.tieba.baidu.com/tb/static-frs/component/sign_shai/flash_image_loader.js")}},_getTbs:function(b){var a=this;$.ajax({url:"http://tieba.baidu.com/dc/common/imgtbs",dataType:"json",success:function(c){if(c&&c.data&&c.data.tbs&&b&&_.isFunction(b)){b(c.data.tbs)}}})},_uploadImage:function(b){var a=this;a._getTbs(function(d){var c=b.toDataURL().replace(/^.*base64\,/,"");window.FlashImageLoader.bind("uploadComplete",a._uploadedHandler,a);window.FlashImageLoader.uploadBase64("http://upload.tieba.baidu.com/upload/pic",c,{tbs:d})})},_uploadedHandler:function(a,d){var c=$.json.decode(d);if(c.error_code!=0){alert("\u56fe\u7247\u4e0a\u4f20\u9519\u8bef\uff0c\u8bf7\u91cd\u8bd5")}else{var b=c.info.pic_id_encode;var e="http://imgsrc.baidu.com/forum/pic/item/"+b+".jpg";window.rich_postor._editor.execCommand("insertimage",e,5);this.sketchpad.destroy();window.FlashImageLoader.unbind("uploadComplete",this._uploadedHandler);this.overlay.close(true)}},destroy:function(){this.sketchpad.destroy();if(window.FlashImageLoader){window.FlashImageLoader.unbind("uploadComplete",this._uploadedHandler)}this.container.html("")}};PicassoPanel.template='<div class="tb_picasso_vcanvas">    <div class="tb_picasso_content"></div>    <div class="sketchpad_v_toolbar">        <ul>            <li>                <ul class="color_panel clearfix">                    <li><div style="background: #FFFFFF;border: 1px solid #FFFFFF;"></div></li>                    <li><div style="background: #B5B5B5;border: 1px solid #B5B5B5;"></div></li>                    <li><div style="background: #F79579;border: 1px solid #F79579;"></div></li>                    <li><div style="background: #FDC58B;border: 1px solid #FDC58B;"></div></li>                    <li><div style="background: #80C99C;border: 1px solid #80C99C;"></div></li>                    <li><div style="background: #000000;border: 1px solid #000000;"></div></li>                    <li><div style="background: #626262;border: 1px solid #626262;"></div></li>                    <li class="focus"><div style="background: #ED2329;border: 1px solid #ED2329;"></div></li>                    <li><div style="background: #F79323;border: 1px solid #F79323;"></div></li>                    <li><div style="background: #00A451;border: 1px solid #00A451;"></div></li>                    <li><div style="background: #6CCEF7;border: 1px solid #6CCEF7;"></div></li>                    <li><div style="background: #F499C0;border: 1px solid #F499C0;"></div></li>                    <li><div style="background: #00ACEE;border: 1px solid #00ACEE;"></div></li>                    <li><div style="background: #EC008B;border: 1px solid #EC008B;"></div></li>                    <li><div style="background: #D8003D;border: 1px solid #D8003D;"></div></li>                </ul>            </li>            <li class="sketchpad_button_brush">                <ul class="sketchpad_brush_panel clearfix">                    <li class="brush_button brush_small" data-brush-type="brush">1</li>                    <li class="brush_button brush_middle focus" data-brush-type="brush">3</li>                    <li class="brush_button brush_big" data-brush-type="brush">5</li>                </ul>            </li>            <li class="sketchpad_button_eraser">                <ul class="sketchpad_brush_panel clearfix">                    <li class="brush_button brush_small" data-brush-type="eraser">1</li>                    <li class="brush_button brush_middle" data-brush-type="eraser">3</li>                    <li class="brush_button brush_big" data-brush-type="eraser">5</li>                </ul>            </li>            <li>                <div class="sketchpad_bg_input">                    <button type="button" class="sketchpad_add_bg">\u6dfb\u52a0\u80cc\u666f</button>                    <input type="file" class="sketchpad_image_input" />                </div>            </li>            <li>                <button type="button" class="sketchpad_remove_bg disabled">\u5220\u9664\u80cc\u666f</button>            </li>        </ul>    </div>    <div class="sketchpad_h_toolbar">        <button type="button" class="sketchpad_undo" disabled="disabled">\u4e0a\u4e00\u6b65</button>        <button type="button" class="sketchpad_redo" disabled="disabled">\u4e0b\u4e00\u6b65</button>        <button type="button" class="sketchpad_clear" disabled="disabled">\u6e05\u7a7a</button>        <button type="button" class="sketchpad_finish">\u753b\u597d\u4e86</button>    </div>    <canvas class="sketchpad_sign" width="416" height="335"  style="display: none;" ></canvas>    <div class="picasso_message" style="display: none;">        <p>\u5c1a\u672a\u4f5c\u753b\uff0c\u767d\u7eb8\u4e00\u5f20\uff01&gt;.&lt;</p>        <p><button type="button" class="picasso_message_apply">\u786e\u5b9a</button></p>    </div></div>';;(function(){function h(){}h.prototype={constructor:h,init:function(n){var m=navigator.userAgent.toLowerCase().match(/chrome\/([\d]+)/);if((m&&parseInt(m[1])>=21)||$.browser.mozilla){var l=this;_.Module.use("common/component/htmlx_img_editor",[],function(o){window.htmlXimgEditor=o;o.addDelegateContainer(n.editArea,"."+n.config.imageClassName);o.setRichEditor(n);l.imageEditor=o})}}};function a(){this.editorOffsetTop=0;this.editor=null;this.editorYdistanceToButton=200}a.prototype={constructor:a,init:function(l){this.editor=l;l.enableAutoHeight(this.getEditorMaxHeight());l.on("heightChanged",this.onEditorHeightChanged,this);l.on("focus",this.onEditorFocus,this);var m=this;if(document.addEventListener){window.addEventListener("resize",function(){m.editor.enableAutoHeight(m.getEditorMaxHeight())},false)}else{window.attachEvent("onresize",function(){m.editor.enableAutoHeight(m.getEditorMaxHeight())})}},onEditorHeightChanged:function(n,o){var m=document.body.scrollTop?document.body.scrollTop:document.documentElement.scrollTop;var l=document.body.scrollLeft?document.body.scrollLeft:document.documentElement.scrollLeft;if(m>=this.editorOffsetTop-20){return}window.scrollTo(l,m+o)},onEditorFocus:function(){this.editorOffsetTop=this.getPageY(this.editor.wrapper)},getPageY:function(l){return l.offsetParent?l.offsetTop+this.getPageY(l.offsetParent):l.offsetTop},getEditorMaxHeight:function(){var l=(window.innerHeight)?window.innerHeight:(document.documentElement&&document.documentElement.clientHeight)?document.documentElement.clientHeight:document.body.offsetHeight;l-=this.editorYdistanceToButton;}};{this.editor=null;this.editValidHTML=["br","img","strong","span","b","font"];this.isAutoImage=l===undefined?true:l;this.isFirstTimeImgRec=true;this.timer=null;this.enable=true}d.prototype={init:function(l){this.editor=l;if($.browser.opera===true){return}l.on("paste",this.filteHTML,this);l.on("keyup",this.dealWithKeyup,this);l.on("keydown",this.onEditorKeydown,this)},onEditorKeydown:function(l){clearTimeout(this.timer);if(l.keyCode===229){this.enable=false}else{this.enable=true}},dealWithKeyup:function(o){if(!this.enable){return}if(this.editor.hasSelection()){return}var p=this;if(p.timer){clearTimeout(p.timer)}var n=o||window.event;var m=(n.ctrlKey&&n.keyCode==86);var l=this;p.timer=setTimeout(function(q){if(l.editor.editorPlugins.refer&&l.editor.editorPlugins.refer.box.isShow){return}p.preFilte();if(!q){p.autoRecognizeImgUrl()}},300)},filteHTML:function(m){m.exitFunction=true;var l=this;setTimeout(function(){l.preFilte();if(l.isAutoImage==true){l.autoRecognizeImgUrl();l.dealWithImages()}},50)},createImageTagFromUrl:function(l){var m='<img unselectable="on" src="_LEG_IMG_" class="BDE_Image" onload="TED.EditorCore.ResizeImage(this);" onerror="Stats.sendRequest(\'fr=tb0_forum&st_mod=editor&st_type=urlimagefail&st_value=1\');this.removeAttribute(\'onload\');this.removeAttribute(\'onerror\');" />';return m.replace("_LEG_IMG_",l)},createVideoFromUrl:function(l,n,o){var m='<img unselectable="on" width="219" height="174" data-width="500" data-height="450" ';if(n){m+=' video_url="'+n+'"'}if(o){m+=' video_mp4_url="'+o+'"'}m+=' title="'+l+'" src="/tb/editor/v2/flash.png" class="BDE_Flash"/><br />';return m},convert_urls:[[/http:\/\/client\.joy\.cn\/flvplayer\/([0-9a-zA-Z]*)_([0-9]*)_[1-9]*_([0-9]*)\.swf$/ig,"http://client.joy.cn/flvplayer/$1_$2_0_$3.swf"],[/http:\/\/www\.letv\.com\/player\/x([0-9a-zA-Z_]*)\.swf$/ig,"http://www.letv.com/player/share/baidu/x$1.swf"],[/http:\/\/www\.kankanews\.com\/object\/kankanewsplayer([0-9a-zA-Z\-\.]*)\.swf/ig,"http://www.kankanews.com/object/kankanewsplayer3.0.swf"],[/http:\/\/www\.m1905\.com\/video\/m\/([0-9]*)\/v\.swf/ig,"http://www.m1905.com/video/s/$1/v.swf?autoplay=0"],[/(http:\/\/share\.vrs\.sohu\.com\/[0-9a-zA-Z_]*\/v\.swf)(\S*)$/ig,"$1&autoplay=false"],[/http:\/\/v\.youku\.com\/v_show\/id_([0-9a-zA-Z_]+)\.html/ig,"http://player.youku.com/player.php/sid/$1/v.swf"],[/http:\/\/www\.tudou\.com\/programs\/view\/([0-9a-zA-Z]*)\/?$/ig,"http://www.tudou.com/v/$1/v.swf"],[/http:\/\/v\.ku6\.com\/show\/([0-9a-zA-Z_\.&\?]+).html/ig,"http://player.ku6.com/refer/$1/v.swf"],[/http:\/\/v\.ku6\.com\/special\/([0-9a-zA-Z_\.&\?]+).html/ig,"http://player.ku6.com/refer/$1/v.swf"],[/http:\/\/www\.56\.com\/u([0-9a-zA-Z_]+)\/([0-9a-zA-Z_\.&\?]+).html/ig,"http://player.56.com/$2.swf"]],convertToMp4:[],convert:function(m,l){var o=l,p=m;for(var n=0;n<o.length;n++){m=m.replace(o[n][0],o[n][1])}return m},auto_params:[["client.joy.cn","playstatus",/playstatus=/ig,"0"],["//v.ifeng.com","AutoPlay",/AutoPlay=/ig,"false"],["m1905.com","autoplay",/autoplay=/ig,"0"],["kankanews.com","otherLink",/otherLink=/ig,"false"]],filter_param:function(n){if(n.indexOf("share.vrs.sohu.com")<0){n=n.replace(/(\&)?\w*auto\w*=[\w\d]+/ig,"")}var o=this.auto_params;for(var l=0;l<o.length;l++){var m=o[l];if(n.indexOf(m[0])>-1){n=n.replace(m[2],"old_invalid=");n+=(n.indexOf("?")>-1?"&":"?")+m[1]+"="+m[3]}}return n},videoUrlRec:function(m,l,q,o){var r=this;var n=m;var p="";m=r.convert(m,r.convert_urls);if(!r.isWhiteList_video(m)){return m}p=r.convert(n,r.convertToMp4);if(p==n){p=""}m=r.filter_param(m);Stats.sendRequest("fr=tb0_forum&st_mod=editor&st_type=urlVideoRec&st_value=1");return r.createVideoFromUrl(m,n,p)},isWhiteList_video:function(n){var l=this.editor.config.flashWhiteList;for(var o=0,m=l.length;o<m;o++){if(n.indexOf(l[o])==0){return true}}return false},dealWithImages:function(){this.editor.saveCursor();var l=this.editor.editArea.getElementsByTagName("img");for(var m=0;m<l.length;m++){var n=l[m].className;if(n=="BDE_Image"||n=="BDE_Smiley"||n=="BDE_Flash"||n=="BDE_Music"||n=="BDE_Empty"||l[m].getAttribute("id")=="editor-tmp-img"){continue}var o=document.createElement("img");var p=l[m].getAttribute("src");if(!(/\.gif|\.png|\.bmp|\.jpeg|\.jpg$/.test(p))){p+=".gif"}if(!(/^http/).test(p)){p="http://"+document.domain+p}o.setAttribute("src",p);o.className="BDE_Image";o.setAttribute("onload","TED.EditorCore.ResizeImage(this)");l[m].parentNode.replaceChild(o,l[m])}this.editor.ensureCursor()},autoRecognizeImgUrl:function(){this.editor.saveCursor();var n=this;var l=/(?:<img.*?>)|(?:<emb.*?>)|(?:http:\/\/((?:[a-zA-Z\d\-]+\.)+[a-zA-Z\d]+(?:\:[\d]{2,5})?)\/([^\s]+?)\.(jpg|jpeg|gif|png|bmp))/gi;var m=this.editor.editArea.innerHTML;m=m.replace(l,function(q,o,u,r,p,t){if(q.charAt(0)=="<"){return q}else{n.sendStatistics(1);return n.createImageTagFromUrl(q)}});this.editor.editArea.innerHTML=m;this.editor.ensureCursor()},preFilte:function(){var m=this;this.editor.saveCursor();var l=this.editor.editArea.innerHTML;this.editor.editArea.innerHTML=l.replace(/_moz_dirty=""/gi,"").replace(/\[/g,"[[-").replace(/\]/g,"-]]").replace(/<\/ ?tr[^>]*>/gi,"[br]").replace(/<\/ ?td[^>]*>/gi,"&nbsp;&nbsp;").replace(/<(ul|dl|ol)[^>]*>/gi,"[br]").replace(/<(li|dd)[^>]*>/gi,"[br]").replace(/<p [^>]*>/gi,"[br]").replace(/<span[^>]*class="?edit_font_normal"?[^>]*>/gi,'[span class="edit_font_normal"]').replace(/<span[^>]*class="?edit_font_color"?[^>]*>/gi,'[span class="edit_font_color"]').replace(/<font[^>]*color=(\")?#E10602(\")?[^>]*>/gi,'[font color="#E10602"]').replace(/<font[^>]*color=(\")?#333333(\")?[^>]*>/gi,'[font color="#333333"]').replace(/<font[^>]*>/gi,'[font color="#333333"]').replace(new RegExp('<span([^>]*class="?at"?[^>]*)>',"gi"),"[span$1]").replace(/<span[^>]*>/gi,'<span class="edit_font_normal">').replace(new RegExp("<(/?(?:"+this.editValidHTML.join("|")+")[^>]*)>","gi"),"[$1]").replace(/<[^>]*>/g,"").replace(/\[\[\-/g,"[").replace(/\-\]\]/g,"]").replace(new RegExp("\\[(/?(?:"+this.editValidHTML.join("|")+"|img|span)[^\\]]*)\\]","gi"),"<$1>");if(!$.browser.mozilla){this.editor.editArea.innerHTML=this.editor.editArea.innerHTML.replace(/\r?\n/gi,"<br>")}this.editor.ensureCursor()},sendStatistics:function(l){if(l==1){Stats.sendRequest("fr=tb0_forum&st_mod=editor&st_type=urlimagerec&st_value=1");if(this.isFirstTimeImgRec){this.sendStatistics(3);this.isFirstTimeImgRec=false}}else{if(l==2){Stats.sendRequest("fr=tb0_forum&st_mod=editor&st_type=urlimagefail&st_value=1")}else{if(l==3){Stats.sendRequest("fr=tb0_forum&st_mod=editor&st_type=urlimageposts&st_value=1")}else{return}}}}};window.TED["EditorPlugins"]["SaveDraft"]=e;function e(m,o,n,l){this.isPb=!!l;this.key="d-"+m+"-"+o+"-"+n}e.prototype={saveInterval:5000,timer:null,savedHtml:null,maxNum:3,storageKey:"tb_editor_storage",init:function(m){if(!k.isSupport()){return}this.editor=m;this.initTip();this.get();var l=this;if(m.focused){this.save()}m.on("blur",function(){clearInterval(this.timer)},this);m.on("focus",function(){this.save()},this);m.on("gethtml",function(){clearInterval(this.timer);this.clearData()},this)},save:function(){var l=this;this.timer=setInterval(function(){if(l.savedHtml!==l.editor.editArea.innerHTML){l.set();l.savedHtml=l.editor.editArea.innerHTML}},this.saveInterval)},clearData:function(){var n=k.get(this.storageKey);if(n===null){return}n=n.split("_");for(var m=0,l=n.length;m<l;m++){if(n[m]===this.key){n.splice(m,1);if(n.length===0){k.remove(this.storageKey)}else{k.set(this.storageKey,n.join("_"))}k.remove(this.key);return}}},set:function(){var m=k.get(this.storageKey);if(m===null){k.set(this.storageKey,this.key);k.set(this.key,this.editor.editArea.innerHTML)}else{m=m.split("_");var l=this.isInArray(this.key,m);if(l===false){if(m.length>=this.maxNum){k.remove(m.shift())}m.push(this.key);k.set(this.storageKey,m.join("_"))}k.set(this.key,this.editor.editArea.innerHTML)}if(this.tip){this.tip.onSave(new Date().getTime())}},get:function(){var l=k.get(this.key);if(l===null){return}this.editor.setHtml(l);if(this.tip){this.tip.show()}},isInArray:function(n,o){for(var m=0,l=o.length;m<l;m++){if(o[m]===n){return m}}return false},initTip:function(){this.tip=new f(this,!this.isPb)}};function f(l,m){this.storage=l;this.needBlink=m===undefined?true:m;this.holder=document.createElement("div");this.holder.innerHTML="\u4f60\u4e0a\u6b21\u672a\u53d1\u8868\u7684\u5185\u5bb9\u5df2\u81ea\u52a8\u6062\u590d";this.holder.className="storageTip";this.holder.style.display="none";this.storage.editor.wrapper.appendChild(this.holder)}f.prototype={holder:null,setDateCount:0,needBlink:true,show:function(){if(this.storage.editor.isEmpty()){return}$(this.holder).fadeIn()},onSave:function(l){if(this.storage.editor.isEmpty()){$(this.holder).fadeOut();return}else{this.holder.style.display="block"}this.setDate(l)},setDate:function(l){this.holder.innerHTML="\u4f60\u6b63\u5728\u8f93\u5165\u7684\u5185\u5bb9\u5df2\u81ea\u52a8\u4fdd\u5b58,"+new Date(l).toLocaleTimeString();if(!this.needBlink){return}if(this.setDateCount%5===0){$(this.holder).css("backgroundColor","yellow").animate({backgroundColor:"#efefef"},500,function(){this.style.backgroundColor=""})}this.setDateCount++}};window.TED["EditorPlugins"]["FontEditPlugin"]=j;function j(l){this.c_sign_num=l;this.power=this._getPower()}j.prototype={init:function(n){var u=this,m=u.power;if(m=="none"){return}this.editorRef=n;n.toolbar.holder.innerHTML+='<span class="font_strong" unselectable="on" data-cmd="fontStrong"></span><span class="font_color '+(m=="bold"?"font_color_disable":"")+'" unselectable="on" data-cmd="fontColor"></span>';$(n.container).find(".font_strong").mousedown(function(v){document.execCommand("bold",false,"");$.stats.sendRequest("fr=tb0_forum&st_mod=postor&st_type=sign&st_value=bold");v.preventDefault()});var r=$(n.wrapper);var p={content:"\u4fdd\u6301\u8fde\u7eed\u7b7e\u523010\u5929\u53ca\u4ee5\u4e0a\uff0c\u9009\u4e2d\u6587\u5b57\u70b9\u51fb\u52a0\u7c97",arrow_dir:"up",bubble_css:{top:-45,right:50,width:180},arrow_pos:{left:30},attr:" id='tb_postor_b_tip' ",wrap:r};var s=new UiBubbleTipBase(p),q,l;s.j_bubble.find(".j_ui_triangle").hide();r.find(".font_strong").hover(function(){q=setTimeout(function(){s.showBubble()},1000)},function(){clearTimeout(q);s.hideBubble()});var o={content:"\u4fdd\u6301\u8fde\u7eed\u7b7e\u523020\u5929\u53ca\u4ee5\u4e0a\uff0c\u9009\u4e2d\u6587\u5b57\u70b9\u51fb\u6807\u7ea2",arrow_dir:"up",bubble_css:{top:-45,right:30,width:180},arrow_pos:{left:30},attr:" id='tb_postor_c_tip' ",wrap:r};var t=new UiBubbleTipBase(o);t.j_bubble.find(".j_ui_triangle").hide();r.find(".font_color").hover(function(){l=setTimeout(function(){t.showBubble()},1000)},function(){clearTimeout(l);t.hideBubble()});if(m=="all"){$(n.container).find(".font_color ").mousedown(function(x){var v=document.queryCommandValue("forecolor")?document.queryCommandValue("forecolor").toString():"";var w=$.trim(v);if(w=="#E10602"||w=="132833"||w=="rgb(225, 6, 2)"){document.execCommand("forecolor",false,"#333333")}else{document.execCommand("forecolor",false,"#E10602")}$.stats.sendRequest("fr=tb0_forum&st_mod=postor&st_type=sign&st_value=color");x.preventDefault()})}},_getPower:function(){var l=this.c_sign_num;if(l<10){return"none"}else{if(l<20){return"bold"}else{return"all"}}}};window.TED["EditorPlugins"]["IdiskPlugin"]=g;function g(l,n,o,m){this.power=l;this.fid=n;this.max_length=o;this.max_size=m;this.remainder_lenght=o;this.capacity=0}g.prototype={buttonId:"idisk_btn",flashCntClassName:"idisk_flash_cnt",flashInited:false,isOtherOpend:false,init:function(m){this.editorRef=m;var l=this;this.overlay=new b(m.wrapper,m);this.overlay.on("close",function(){m.focus()});m.overlay.on("open",function(){if(this.overlay.isOpen){this.overlay.close()}},this);this.overlay.on("open",function(){if(this.editorRef.overlay.isOpen){this.editorRef.overlay.close()}},this);m.toolbar.holder.innerHTML+='<label></label><span class="idisk" data-cmd="idisk"></span>';m.toolbarcmd_idisk=function(n){if(!l.power){return[false]}l.overlay.toggle();if(!l.flashInited){$.getJSON("http://pcs.baidu.com/rest/2.0/pcs/quota?app_id=419237&method=info&callback=?",function(o){if(o.error_code){$("#idisk_btn").next().html("\u8fde\u63a5\u5931\u8d25")}else{l.capacity=o.quota-o.used;$("#idisk_btn").show().next().hide();$.JsLoadManager.use(m.config.rootPath+"editor_dialog/idisk/idisk.js",function(){l.initFlash();l.flashInited=true})}})}return[false]};m.toolbar_hovercmd_idisk=function(n){if(!l.power){this.hoveroverlay.open("345px","43px","290px","55px","160px","http://tieba.baidu.com/tb/editor/v2/idisk/noright.html?t=201211201108",n)}return[false]};m.toolbar_hoverendcmd_idisk=function(n){if(!l.power){this.hoveroverlay.close()}return[false]}},initFlash:function(){var l=this;var m=this.overlay.uploadBtn;var n=$(m).position();this.$flashCnt=$("<div>").css({left:n.left+"px",top:n.top+"px",position:"absolute"}).appendTo(m.offsetParent);this.fileUploader=new FileUploader({width:m.offsetWidth,height:m.offsetHeight,container:this.$flashCnt[0],UIContainer:this.editorRef.editAreaWrapper,url:this.editorRef.config.rootPath+"editor_dialog/idisk/FileLoaderPlus.swf?_t=201211292"},{max_length:this.max_length,forum_id:this.fid,upload_size_limit:this.max_size,storage_capacity:this.capacity,upload_url:"http://pcs.baidu.com/rest/2.0/pcs/file?method=upload&dir=%2fapps%2ftieba&ondup=newcopy&app_id=419237&BDUSS="+$.cookie("BDUSS")});this.fileUploader.on("file_added",function(){if(this.overlay.isOpen){this.overlay.close()}if(l.remainder_lenght>0){l.remainder_lenght--;$("#attachmentNumberCount").text(l.remainder_lenght)}},this);this.fileUploader.on("remove_file",function(o){if(l.remainder_lenght<l.max_length){l.remainder_lenght++;$("#attachmentNumberCount").text(l.remainder_lenght)}this.editorRef.fireEvent("idisk_remove_file",null,[o])},this);this.fileUploader.on("upload_complete",function(o){this.editorRef.fireEvent("idisk_upload_complete",null,[o])},this);this.fileUploader.on("uploading_file_start",function(o){this.editorRef.fireEvent("idisk_uploading_start")},this);this.fileUploader.on("uploading_file_stop",function(o){this.editorRef.fireEvent("idisk_uploading_stop")},this)}};function b(l,n){b.superclass.call(this);var m=this;this.editorRef=n;this.max_size=this.byte2str(option_editor.upload_max_size);this.max_length=option_editor.upload_max_length;this.$holder=$("<div>").attr("class",this.holderClass).css("left","-1000px").html('<div class="idisk_btn_container"><button id="'+this.uploadBtnId+'" style="display: none;">\u4e0a\u4f20\u6587\u4ef6</button><span>\u6b63\u5728\u8fde\u63a5\u767e\u5ea6\u4e91\uff0c\u8bf7\u7a0d\u5019...</span></div>\u8fd8\u80fd\u4e0a\u4f20<em id="attachmentNumberCount">'+this.max_length+"</em>\u4e2a\u9644\u4ef6\uff0c\u6bcf\u4e2a\u9644\u4ef6\u5c0f\u4e8e<em>"+this.max_size+'</em><br/>\u9644\u4ef6\u5c06\u540c\u6b65\u5230\u767e\u5ea6\u4e91\u7f51\u76d8\uff0c\u60a8\u7684\u5269\u4f59\u7a7a\u95f4\uff1a<em id="idisk_unused"></em> <a href="http://pan.baidu.com/" target="_blank">\u6574\u7406\u7f51\u76d8</a>').append('<div class="close"></div>').find(".close").click(function(){m.onClose()}).end().append('<div class="arrow"></div>').appendTo(l);this.uploadBtn=this.$holder.find("button")[0]}i(b,c,{holderClass:"tb-editor-overlay idisk_holder",uploadBtnId:"idisk_btn",isOpen:false,onClose:function(){this.close()},close:function(){this.$holder.css("left","-1000px");this.isOpen=false;this.fireEvent("close")},open:function(){var m=this;$.getJSON("http://pcs.baidu.com/rest/2.0/pcs/quota?app_id=419237&method=info&callback=?",function(o){if(o.error_code){$("#idisk_unused").text("\u8bfb\u53d6\u51fa\u9519")}else{$("#idisk_unused").text(m.byte2str(o.quota-o.used))}});if(TED.Editor.Status.isPicassoOpen===true){var n=this;var l=$.dialog.confirm('<div id="maincontent" style="position:absolute;"><img style="margin:10px 10px 10px 10px;width:68px;height:68px;" src="http://static.tieba.baidu.com/tb/editor/v2/picasso/alarm.gif" /><div id="tipscontent" style="position:absolute;left:100px;top:15px;width:270px;font-size:14px;font-family:\u5b8b\u4f53" ><b>\u60a8\u6b63\u5728\u7f16\u8f91\u6d82\u9e26\uff0c\u73b0\u5728\u9000\u51fa\u5c06\u4e0d\u4f1a\u4fdd\u5b58\uff0c\u60a8\u786e\u5b9a\u8981\u9000\u51fa\uff1f</b></div></div>',{title:"\u6d82\u9e26\u7f16\u8f91\u5668",acceptValue:"\u786e\u5b9a",cancelValue:"\u53d6\u6d88"});l.width(420);l.height(90);l.bind("onaccept",function(){TED.Editor.Status.isPicassoOpen=false;n.editorRef.overlay.close(true);n.$holder.css("visibility","visible");n.isOpen=true;n.fireEvent("open")})}else{this.$holder.css("left","140px");this.isOpen=true;this.fireEvent("open")}},toggle:function(){if(this.isOpen){this.close()}else{this.open()}},byte2str:function(l){l=parseInt(l);if(l<1024){return l+"byte"}var m=(l/1024).toFixed(2);if(m<1024){return m+"KB"}var n=(m/1024).toFixed(2);if(n<1024){return n+"MB"}return(n/1024).toFixed(2)+"GB"}})})();;(function(){var g=TED.EditorCore,i=TED.extend,c=TED.EventDispatcher,a=TED.Overlay,d=TED.HoverOverlay,j=TED.Event,k=TED.EditorInstanceManager,h=TED.augmentObject,b=TED.SimpleAjax;window.TED["Editor"]=f;function f(l){if(this.ua.mobile||this.isUCWeb()||this.isAndroidOS()){return new TED.TextInput(l)}f.superclass.call(this,l)}f.defaultConfig={height:"200px",width:"655px",maxHeight:null,autoFocus:false,autoEnable:true,autoHeight:true,wrapperClassName:"tb-editor-wrapper",editAreaClassName:"tb-editor-editarea",editAreaWrapperClassName:"tb-editor-editarea-wrapper",disabledEditAreaClassName:"tb-editor-editarea tb-editor-editarea-disabled",disabledWrapperClassName:"tb-editor-wrapper tb-editor-wrapper-disabled",imageClassName:"BDE_Image",smileyClassName:"BDE_Smiley",musicClassName:"BDE_Music",flashClassName:"BDE_Flash",flashNumLimit:10,rootPath:"/tb/static-common/",enableRefer:true,emptyClassName:"BDE_Empty",didaDelay:300,imageWidthLimit:570};f.Status={isPicassoOpen:false};i(f,g,{getHtml:function(){return this.img2embed(f.superclass.prototype.getHtml.call(this,this.editArea.innerHTML))},hasPicassoAuth:function(){if(this.config.picasso&&!this.config.no_post_pic){return true}return false},enable:function(){this.toolbar.enable();f.superclass.prototype.enable.call(this)},disable:function(){this.toolbar.disable();if(this.overlay.isOpen){this.overlay.close()}f.superclass.prototype.disable.call(this)},getFlashNum:function(){return this.getTagNum("img","BDE_Flash")},getMusicNum:function(){return this.getTagNum("img","BDE_Music")},getConfig:function(){return this.config},overlay:null,toolbar:null,hoveroverlay:null,initComponents:function(l){f.superclass.prototype.initComponents.call(this,l);this.overlay=new a(this.wrapper);this.hoveroverlay=new d(this.wrapper);this.toolbar=new e(this.wrapper,this.hasPicassoAuth())},attachEvents:function(){f.superclass.prototype.attachEvents.call(this);this.toolbar.on("command",this.toolbarcmd,this);this.toolbar.on("hovercommand",this.toolbarhovercmd,this);this.toolbar.on("hoverendcommand",this.toolbarhoverendcmd,this);this.overlay.on("close",function(){this.focus()},this)},detachEvents:function(){f.superclass.prototype.detachEvents.call(this);this.toolbar.remove("command",this.toolbarCommand);this.toolbar.remove("hovercommand",function(){});this.toolbar.remove("hoverendcommand",function(){})},toolbarcmd:function(m,l){if(m&&typeof this["toolbarcmd_"+m]==="function"){this["toolbarcmd_"+m](l)}},toolbarhovercmd:function(m,l){if(m&&typeof this["toolbar_hovercmd_"+m]==="function"){this["toolbar_hovercmd_"+m](l)}},toolbarhoverendcmd:function(m,l){if(m&&typeof this["toolbar_hoverendcmd_"+m]==="function"){this["toolbar_hoverendcmd_"+m](l)}},toolbarcmd_smiley:function(l){this.overlay.toggle("120px","43px","420px","355px","144px",this.config.rootPath+"editor_dialog/smiley/smiley.html?id="+this.id+"&bavl=false&t=20121101",l);$.stats.hive("toolbar_similey");return[false]},toolbarcmd_image:function(l){this.overlay.toggle("0px","43px","540px","260px","13px",this.config.rootPath+"editor_dialog/image/multipleupload.html?t=201301141927&v=1.4&id="+this.id,l);$.stats.hive("toolbar_images");return[false]},toolbarcmd_music:function(l){var n=this;var m=n.config.bavl;if(m>=2){n.overlay.toggle("55px","43px","500px","400px","126px",n.config.rootPath+"editor_dialog/music/music.html?id="+n.id,l)}else{n.overlay.toggle("55px","43px","320px","65px","126px",n.config.rootPath+"editor_dialog/music/music_error.html?id="+n.id,l)}$.stats.hive("toolbar_music");return[false]},toolbarcmd_flash:function(l){this.overlay.toggle("25px","43px","530px","155px","71px",this.config.rootPath+"editor_dialog/video/video.html?id="+this.id+"&t=20121221",l);$.stats.hive("toolbar_video");return[false]},toolbarcmd_picasso:function(n){if(this.hasPicassoAuth()){var o=!!document.createElement("canvas").getContext;var l=(typeof FileReader)!="undefined";if(o&&l){if(this.overlay.currentOpen&&this.overlay.currentOpen===n){this.overlay.close()}else{n.className=n.className+" open";this.overlay.currentOpen=n;this.overlay.isOpen=true;var m=new PicassoPanel(this.overlay.content,this.overlay);$(this.overlay.holder).css({left:105,top:43,width:500,height:370,display:"block"});m.sketchpad.refreshPosition();this.overlay.arrow.style.left="244px";this.overlay.fireEvent("open");this.overlay.picassoPanel=m;f.Status.isPicassoOpen=true}}else{this.overlay.toggle("105px","43px","500px","370px","244px",this.config.rootPath+"editor_dialog/picasso/picasso.html?id="+this.id,n);f.Status.isPicassoOpen=true}}$.stats.hive("toolbar_picasso");return[false]},jumpTo_picasso:function(){if(this.hasPicassoAuth()){this.overlay.open("105px","43px","500px","370px","244px",this.config.rootPath+"editor_dialog/picasso/picasso.html?id="+this.id);f.Status.isPicassoOpen=true}return[false]},toolbarcmd_cut_screen:function(n){var o=this,m=$.ajax({url:"http://tieba.baidu.com/dc/common/imgtbs",dataType:"json"}),l=window.external.GetNextReqID("id");$.stats.hive("toolbar_cutscreen");window.cutScreen=function(p,q){if(p!=l||!q||!(q=$.parseJSON(q))||q.result==="error"||!q.content||!q.content.url){return}o.execCommand("inserthtml",'<img unselectable="on" class="BDE_Image" onload="TED.EditorCore.ResizeImage(this);"  src="'+q.content.url+'">');o.execCommand("insertlinebreak")};m.done(function(p){if(p.no==0){try{window.external.StartRequest(l,"bdbrowser.extension.tiebacmdToLibEx","cutScreen",'{"cmd":"PageSnapStart","fid":"'+o.config.forum_id+'","tbs":"'+p.data.tbs+'"}',window,"")}catch(q){}}});return[false]},toolbar_hovercmd_smiley:function(l){return[false]},toolbar_hoverendcmd_smiley:function(l){return[false]},toolbar_hovercmd_image:function(l){return[false]},toolbar_hoverendcmd_image:function(l){return[false]},toolbar_hovercmd_music:function(l){return[false]},toolbar_hoverendcmd_music:function(l){return[false]},toolbar_hovercmd_flash:function(l){return[false]},toolbar_hoverendcmd_flash:function(l){return[false]},toolbar_hovercmd_disableimage:function(l){this.hoveroverlay.open("0px","43px","268px","40px","13px",this.config.rootPath+"editor_dialog/image/image_noright.html?t=201210161100",l)},toolbar_hoverendcmd_disableimage:function(l){this.hoveroverlay.close()},toolbar_hovercmd_picasso:function(l){if(!this.hasPicassoAuth()){if(this.config.no_post_pic){this.hoveroverlay.open("307px","43px","250px","42px","40px",this.config.rootPath+"editor_dialog/picasso/pic_noright.html?t=201111141108",l)}else{this.hoveroverlay.open("307px","43px","290px","55px","40px",this.config.rootPath+"editor_dialog/picasso/picasso_noright.html?t=201111141108",l)}}return[false]},toolbar_hoverendcmd_picasso:function(l){if(this.config.picasso==undefined||this.config.picasso==false){this.hoveroverlay.close()}return[false]},toolbar_hovercmd_unabled_cut:function(l){this.hoveroverlay.open("320px","43px","290px","40px","110px",this.config.rootPath+"editor_dialog/cut_screen/nosupport.html?t=201210151818",l);return[false]},toolbar_hoverendcmd_unabled_cut:function(l){this.hoveroverlay.close();return[false]},getMusiNum:function(){var l=this.getTagNum("embed",this.config.musicClassName);if(!this.ua.ie){l+=this.getTagNum("img",this.config.musicClassName)}return l},getFlashNum:function(){var l=this.getTagNum("embed",this.config.flashClassName);if(!this.ua.ie){l+=this.getTagNum("img",this.config.flashClassName)}return l},cmd_insertmusic:function(l){var m="";m='<img unselectable="on" class="BDE_Music" src="'+this.config.rootPath+'editor_img/music.png"';m+=' title="'+l+'"';m+=' width="400" height="95"';m+=' data-width="400" data-height="95">';this.execCommand("inserthtml",m);return[false]},cmd_insertflash:function(o,r,s,n,m){var p="";var l=450,q=500;if(o.toLowerCase().indexOf("baidu.com")>-1){q=480;l=410}else{if(o.toLowerCase().indexOf("player.video.qiyi.com")>-1){q=500;l=415}else{q=500;l=450}}p='<img unselectable="on" class="BDE_Flash" src="'+this.config.rootPath+'editor_img/flash.png"';if(r){p+=' data-video_url="'+r+'"'}if(n){p+=' data-vsrc="'+r+'"';p+=' data-pkey="'+n+'"';if(m){p+=' data-vpic="'+m+'"'}else{p+=' data-vpic="null"'}}else{p+=' data-vsrc="null"';p+=' data-pkey="null"';p+=' data-vpic="null"'}if(s){p+=' video_mp4_url="'+s+'"'}p+=' title="'+o+'"';p+=' width="219" height="175"';p+=' data-width="'+q+'" data-height="'+l+'"/>';this.execCommand("inserthtml",p);this.execCommand("insertlinebreak");return[false]},img2embed:function(l){return l.replace(/<img[^>]*class="?(?:BDE_Flash|BDE_Music)[^>]*>/gi,function(w){var n=w.replace(/.* title\="?([^\s">]+).*/i,"$1").replace(/&amp;/gi,"&"),o=w.replace(/.* data\-width\="?([^\s">]+).*/i,"$1"),v=w.replace(/.* data\-height\="?([^\s">]+).*/i,"$1"),t=w.replace(/.* class="?([^\s">]+).*/i,"$1"),m="",q='<embed allowfullscreen="true" pluginspage="http://www.macromedia.com/go/getflashplayer" type="application/x-shockwave-flash" wmode="transparent" play="true" loop="false" menu="false" allowscriptaccess="never" scale="noborder"'+(n.toLowerCase().indexOf("http://player.ku6.com")==0?' flashvars="adss=0"':" ")+'src="'+n+'"  class="'+t+'" width="'+o+'" height="'+v+'" ';if(t=="BDE_Flash"){m=w.replace(/.* data-video_url="?([^\s">]+).*/i,"$1").replace(/&amp;/gi,"&");var p=w.replace(/.* data-vsrc="?([^\s">]+).*/i,"$1").replace(/&amp;/gi,"&");var r=w.replace(/.* data-pkey="?([^\s">]+).*/i,"$1");var u=w.replace(/.* data-vpic="?([^\s">]+).*/i,"$1").replace(/&amp;/gi,"&");if(r!="null"&&r.length<40){q+=' vsrc="'+p+'"';if(u!="null"){q+=' vpic="'+u+'"'}q+=' pkey="'+r+'"'}}q+=" >";return q})},quoteContainer:null,quote:function(p,l,q){p=parseInt(p);if(p>1){if(this.quoteContainer===null){this.quoteContainer=document.createElement("div");this.quoteContainer.className="editor-quote";this.wrapper.insertBefore(this.quoteContainer,this.editAreaWrapper)}var o=document.getElementById("post_content_"+l).innerHTML.replace(/<img[^>]*>/gi,"[\u56fe\u7247]").replace(/<embed[^>]*>/gi,"[\u89c6\u9891]").replace(/<br[^>]*>/gi," ").replace(/<a[^>]*>/gi,"").replace(/<\/a>/gi,"").subByte(270);this.quoteContainer.innerHTML='<blockquote class="quote_change"><fieldset><legend ><a href="javascript:void(0);" onmousedown="return false;" style="font-weight:bold;color:#989898; position:absolute;right:5px; top:12px;text-decoration:none;font-size:15px;line-height:15px;font-weight:bold;font-family:\u5fae\u8f6f\u96c5\u9ed1" onclick="TED.Editor.getInstanceById(\''+this.id+'\').unQuote();Stats.sendRequest(\'fr=tb0_forum&st_mod=pb&st_type=quote&st_value=delete\');" class="close" title="\u5220\u9664\u5f15\u7528">\u2573</a>\u5f15\u7528&nbsp;'+q+'&nbsp;(<a href="#'+l+'" style="color:#989898;">'+p+'\u697c</a>)</legend><p style="margin-left: 5px;padding: 0 5px;width: 505px;" class="quote_content">'+o+"</p></fieldset></blockquote>";this.quoteContainer.style.display="block";this.fireEvent("quote",null,[l])}else{this.unQuote();var n="";if(l==="is_p_reply_first"){n="is_p_reply_first"}else{n="rp_reply"}Stats.sendRequest("fr=tb0_forum&st_mod=pb&st_type=quote&st_value="+n)}var m=this;setTimeout(function(){m.focus()},300)},unQuote:function(){if(this.quoteContainer){this.quoteContainer.style.display="none"}this.fireEvent("unquote")}});function e(l,m){e.superclass.call(this);this.hovertimer=null;this.hoverendtimer=null;this.container=l;this.enablepicasso=m;this.initialize()}i(e,c,{disabled:true,initialize:function(){this.holder=document.createElement("div");this.holder.className="tb-editor-toolbar tb-editor-toolbar-disabled";var m='<span class="image" data-cmd="image"></span><label></label><span class="flash" data-cmd="flash"></span><label></label><span class="music" data-cmd="music"></span><label></label><span class="smiley" data-cmd="smiley"></span><label></label><span class="picasso" data-cmd="picasso"></span>',l,n=this;try{l="baidubrowser.tieba"==window.external.GetVersion("version")?true:null}catch(o){l=null}if(l){m+='<label></label><span class="cut_screen" data-cmd="cut_screen">'}else{m+='<label></label><span class="cut_screen" data-cmd="unabled_cut">'}this.holder.innerHTML=m;this.container.appendChild(this.holder);j.addEvent(this.holder,"click",function(q){if(n.disabled){return}var p=q.target||q.srcElement;if(p.tagName.toLowerCase()==="span"){n.fireEvent("command",null,[p.getAttribute("data-cmd"),p])}});j.addEvent(this.holder,"mouseover",function(q){if(n.disabled){return}var p=q.target||q.srcElement;if(p.tagName.toLowerCase()==="span"){if(n.hoverendtimer){clearTimeout(n.hoverendtimer)}n.hovertimer=setTimeout(function(){n.fireEvent("hovercommand",null,[p.getAttribute("data-cmd"),p])},800)}});j.addEvent(this.holder,"mouseout",function(q){if(n.disabled){return}if(n.hovertimer){clearTimeout(n.hovertimer)}var p=q.target||q.srcElement;if(p.tagName.toLowerCase()=="span"){n.hoverendtimer=setTimeout(function(){n.fireEvent("hoverendcommand",null,[p.getAttribute("data-cmd"),p])},400)}})},disable:function(){this.disabled=true;this.holder.className="tb-editor-toolbar tb-editor-toolbar-disalbed"},enable:function(){this.disabled=false;this.holder.className="tb-editor-toolbar"},disableInsertImage:function(){this.holder.firstChild.setAttribute("data-cmd","disableimage");this.holder.firstChild.className="image_disabled"},enableInsertImage:function(){this.holder.firstChild.setAttribute("data-cmd","image");this.holder.firstChild.className="image"}});h(f,k)})();;_.Module.define({path:"common/component/htmlx_img_editor",requires:["common/component/image_uploader"],sub:{initial:function(){this.options={width:650,height:460,asideWidth:165,barHeight:50,imgMaxWidth:1600};this.img=null;this._zoom=1;this._pluginList=[];this._imgList={};this._baseImg=null;this._sourceOptions=null;this._locked=false;this._buildUI();this._initCanvas();this._addEnterButton();this._bindEvent()},_buildUI:function(){this._container=$('<div class="xeditor_ctn"></div>');this.dialog=new $.dialog({title:"\u7f8e\u5316\u56fe\u7247",html:this._container[0],holderClassName:"xeditor_dialog",width:this.options.width,height:this.options.height,show:false,hideOnclose:true,fixed:false,draggable:false});this.dialog.showTitle=true;this._wraper=$('<div class="xeditor_wraper"></div>').appendTo(this._container);this.main=$('<div class="xeditor_main clearfix"></div>').appendTo(this._wraper);this.aside=$('<div class="xeditor_aside clearfix"></div>').appendTo(this._wraper);this.viewer=$('<div class="xeditor_viewer"></div>').appendTo(this.main);this._message=$('<span class="xeditor_message"><img src="/tb/static-common/img/editor/loading.gif" /><span></span></span>').appendTo(this.viewer);this._bottons=$('<div class="xeditor_btns"><a href="#" class="cancel" onclick="return false;">&nbsp</a><a href="#" class="ui_btn ui_btn_m j_btnOk" onclick="return false;"><span><em>\u786e\u8ba4</em></span></a><a href="#" class="restart" onclick="return false;">\u91cd\u65b0\u5f00\u59cb</a>').appendTo(this._container);var a='<dl class="xeditor_tools"><dt class="switch_title"><a class="selected j_switch">\u57fa\u672c\u64cd\u4f5c</a><a class="">\u7f8e\u5316</a></dt><dd class="switch_content"><ul class="xeditor_handle selected"><li class="xeditor_clip">\u88c1\u526a</li><li class="xeditor_rl">\u5de6\u65cb\u8f6c</li><li class="xeditor_rr">\u53f3\u65cb\u8f6c</li></ul><ul class="xeditor_filter"></ul></dd></dl>';this.aside.html(a);this._imgWrapperClass="j_htmlxImageWrapper";this._imgWrapper=$('<div class="'+this._imgWrapperClass+'" contenteditable="false" style="position: relative;display:inline-block;"></div>');this._imgMask=$("<div style=\"position:absolute;border: 1px solid gray;display: table-cell;text-align: center;vertical-align: middle;background-color: rgba(0,0,0,.3);filter:progid:DXImageTransform.Microsoft.gradient(enabled='true',startColorstr='#4C000000', endColorstr='#4C000000');\"></div>").appendTo(this._imgWrapper);this._cancelButton=this._bottons.find(".cancel");this._restartButton=this._bottons.find(".restart");this._submitButton=this._bottons.find(".j_btnOk");this._setContainerHeight()},_setContainerHeight:function(){var c=this.options.height-this.options.barHeight;this.aside.css({width:this.options.asideWidth,height:c});this.main.css({width:this.options.width-this.aside.outerWidth()-parseInt(this.main.css("padding-left"))*2-2,height:c-parseInt(this.main.css("padding-left"))*2});var a=this.aside.find(".switch_title"),b=this.aside.find(".switch_content");b.css({height:c-35})},_initCanvas:function(){this.canvas=document.createElement("canvas");this._canvasStack=[];this.preCanvas=document.createElement("canvas");this.viewer.append(this.preCanvas);this.context=this.canvas.getContext("2d");this.preContext=this.preCanvas.getContext("2d")},addImage:function(b,c,a){this._imgList[b]={sourceData:c,options:a||{}}},_addEnterButton:function(){var a=this;this._enterButton=$('<a contenteditable="false" href="#" class="xeditor_enter_btn1" onclick="return false;"></a>').appendTo(this._imgWrapper);this._enterButton.on("click",function(b){if(!a.pluginLoded){a.addPlugin("clip","htmlx_img_clip");a.addPlugin("rotate","htmlx_img_rotate");a.addPlugin("filter","htmlx_img_filter");a.pluginLoded=true}a.dialog.show();a.dialog.setPosition();a.restart();a.dialog.modal.element.height(a.dialog.modal.height());$.stats.sendRequest("fr=tb0_forum&st_mod=htmlximgeditor&st_value=dialogshow")})},_initImage:function(){var b=this._baseImg;if(b.width>this.options.imgMaxWidth){var e=b.height/b.width;b.width=this.options.imgMaxWidth;b.height=this.options.imgMaxWidth*e}var d=b.width,a=b.height,c=this.canvas;c.width=d;c.height=a;this.context.drawImage(b,0,0,d,a);this.pushOperation("init",this.canvas)},pushOperation:function(a,c){var b=c.cloneNode();b.getContext("2d").drawImage(c,0,0);this._canvasStack.push({operation:a,canvas:b});this.trigger("change",{operation:a})},getLastOperation:function(a,d){for(var c=this._canvasStack.length-1;c>=0;c--){var b=this._canvasStack[c];if((b.operation!=a)==d){return b}}return this._canvasStack[0]},setCanvas:function(b){var a=b.cloneNode();a.getContext("2d").drawImage(b,0,0);this.canvas=null;this.context=null;this.canvas=a;this.context=a.getContext("2d")},initPreviewer:function(){var d=this.canvas,e=d.width,b=d.height,g=this.viewer.width(),a=this.viewer.height(),c=this.preCanvas;var f=e/b;if(e>g&&f>=1){c.width=g;c.height=c.width/f}else{if(b>a&&f<1){c.height=a;c.width=c.height*f}else{c.width=d.width;c.height=d.height}}this._zoom=e/c.width;this.preContext.drawImage(d,0,0,c.width,c.height);this.setImagePosition()},setImagePosition:function(){var c=this.viewer.width(),a=this.viewer.height(),b=this.preCanvas;$(this.preCanvas).css({left:(c-b.width)/2,top:(a-b.height)/2})},_bindEvent:function(){var a=this,b=this.aside.find(".switch_title a"),c=this.aside.find(".switch_content");b.each(function(d){$(this).on("click",function(f){b.removeClass("selected");$(this).addClass("selected");$(c.find("ul").hide().get(d)).show()})});this._imgWrapper.on("mouseleave",function(){a.hideButton();if(a.richEditor){a.richEditor.editorPlugins.draft.save()}});this._cancelButton.bind("click",function(){a.dialog.hide()});this._restartButton.bind("click",function(){if(confirm("\u91cd\u65b0\u5f00\u59cb\u5c06\u64a4\u9500\u6240\u6709\u6b65\u9aa4\u5e76\u6062\u590d\u5230\u539f\u56fe\uff0c\u60a8\u786e\u5b9a\u5417\uff1f")){a.restart();$.stats.sendRequest("st_mod=album&fr=tb0_forum&st_type=restart")}});this._submitButton.bind("click",function(){if(!a.isLocked()){a._submit()}})},addDelegateContainer:function(b,a){var c=this;this._imgContainer=$(b);this._imgSelector=a;this.clearAllButton();$(b).delegate(a,"mouseover",function(d){if(c.richEditor){clearInterval(c.richEditor.editorPlugins.draft.timer)}c.detectImage(this)}).delegate(a,"mouseout",function(d){}).css("position","relative")},setRichEditor:function(b){this.richEditor=b;var a=this;$(b.editArea).on("scroll",function(c){if(a.isButtonVisible()){a.setButtonPosition()}})},detectImage:function(c){var f=c.src;if(!this._imgList[f]){return}if(c.width<120||c.height<120){return}if(this.img===c){this.showButton();return}this.img=c;var e=this._imgList[f],d=e.sourceData,b=this;this._sourceOptions=e.options;if(d.size){var a=new FileReader();a.onload=function(h){a.onload=null;_dataURI=h.target.result;var g=new Image();g.src=_dataURI;g.onload=function(){b._baseImg=g;b.showButton();delete g}};a.readAsDataURL(d)}else{if(typeof d=="string"){var c=new Image();c.src=d;c.onload=function(){b._baseImg=c;b.showButton();delete c}}else{if(/canvas/i.test(d.toString())){this._baseImg=d;this.showButton()}}}},showButton:function(){if(this.isButtonVisible()){this.setButtonPosition();return false}this._imgWrapper.find("img").remove();var a=$(this.img);a.before(this._imgWrapper);this._imgWrapper.append(a).css({width:a.outerWidth(true),height:a.outerHeight(true)});var c={left:this.img.offsetLeft,top:this.img.offsetTop},b={width:a.width(),height:a.height()};this._imgMask.css({top:c.top-1,left:c.left-1,width:b.width,height:b.height});this.setButtonPosition()},setButtonPosition:function(){var e=$(this.img);var b=this._enterButton,d=this._imgWrapper.position(),h={width:e.width(),height:e.height()},g={width:b.width(),height:b.height()},c;var f=this.richEditor.editArea,j=d.top<0?-d.top:0,i=f.clientHeight,a;if(d.top<0){a=h.height-j;a=Math.min(a,i)}else{a=i-d.top;a=Math.min(a,h.height)}c={left:h.width/2-g.width/2,top:j+a/2-g.height/2};this._enterButton.css({display:"block",top:c.top,left:c.left})},isButtonVisible:function(){return jQuery.contains(this._imgWrapper[0],this.img)},hideButton:function(){if(!this.img){return}var a=this;this.img.parentNode.removeChild(this.img);this._imgWrapper.after(this.img);this._imgWrapper[0].parentNode.removeChild(this._imgWrapper[0])},clearAllButton:function(){var a=this._imgSelector;this._imgContainer.find("."+this._imgWrapperClass).each(function(c,d){var e=$(d);if(e.find(a).length){var b=e.find(a)[0];b.parentNode.removeChild(b);e.after(b)}d.parentNode.removeChild(d)})},restart:function(){this._initImage();this.initPreviewer();for(var a in this._pluginList){this._pluginList[a].trigger("restart")}this.releaseLock();this.hideMessage()},clip:function(e){var a=Math.floor(e.x*this._zoom),f=Math.round(e.y*this._zoom),b=Math.round(e.width*this._zoom),d=Math.round(e.height*this._zoom);a=a>0?a:0;f=f>0?f:0;if(a+b>this.canvas.width){b-=a+b-this.canvas.width}if(f+d>this.canvas.height){d-=f+d-this.canvas.height}var c={x:a,y:f,width:b,height:d};this._clipCanvas(this.canvas,c);this.pushOperation("clip",this.canvas);this.initPreviewer();$.stats.sendRequest("fr=tb0_forum&st_mod=htmlximgeditor&st_value=clip")},_clipCanvas:function(b,c){var a=b.getContext("2d"),d=a.getImageData(c.x,c.y,c.width,c.height);a.clearRect(0,0,b.width,b.height);b.width=c.width;b.height=c.height;a.putImageData(d,0,0)},_submit:function(){this.showMessage("\u6b63\u5728\u4e0a\u4f20\uff0c\u8bf7\u7a0d\u540e...");this.addLock("submit");var a=$.ajax({url:"http://tieba.baidu.com/dc/common/imgtbs",dataType:"json"});self=this;a.done(function(d){if(Number(d.no)===0){var b="http://upload.tieba.baidu.com/upload/pic?tbs="+d.data.tbs+(self._sourceOptions.isWater?"&is_wm=1":""),e=self.use("common/component/image_uploader",b),c=self.canvas.cloneNode();c.getContext("2d").drawImage(self.canvas,0,0);e.bind("success",function(g,h,f){self._updateImage(f,c)});e.upload(self.canvas,1024*1024*2)}else{self.richEditor.setStatsRequest("tbsgeterror")}}).fail(function(){self.richEditor.setStatsRequest("tbsgeterror")});$.stats.sendRequest("fr=tb0_forum&st_mod=htmlximgeditor&st_value=imgupload")},_updateImage:function(c,e){var f=c.info.pic_id_encode,g=c.info.fullpic_width,b=c.info.fullpic_height,h=c.info.pic_water,d=this.img,a=TED.EditorCore.defaultConfig.imageWidthLimit;if(!this._sourceOptions.isWater&&!f){this.showMessage("\u4e0a\u4f20\u56fe\u7247\u5931\u8d25",true,2000);this.canvas=e;this.releaseLock();return false}d.src="";d.width=g;d.height=b;if(g>a){d.width=a;$(d).removeAttr("height");$(d).attr("changedsize",true)}else{$(d).removeAttr("changedsize")}if(this._sourceOptions.isWater&&h){d.src=h}else{d.src="http://imgsrc.baidu.com/forum/pic/item/"+f+".jpg"}this.dialog.hide();this.img=null;this.addImage(d.src,e,{isWater:this._sourceOptions.isWater})},addPlugin:function(b,c){var a=this,d;_.Module.use("common/component/"+c,[this],function(e){a._pluginList[b]=e;e.trigger("add_to_editor_success")})},addLock:function(a){this._locked=true;this._locker=a},releaseLock:function(){this._locked=false},isLocked:function(){return this._locked},showMessage:function(e,c,f){this._message.find("span").html(e);this._message.find("img")[c?"hide":"show"]();var g=this.viewer,a=this._message.outerWidth(),d=this._message.outerHeight();this._message.css({left:(g.width()-a)/2,top:(g.height()-d)/2}).show();if(f){var b=this;setTimeout(function(){b.hideMessage()},f)}},hideMessage:function(){this._message.hide()}}});var RichPostor=function(option){var eidtor=$("#"+option.editorDom);this._data_postor=eval("("+eidtor.attr("data-postor")+")");this._data_editor=eval("("+eidtor.attr("data-editor")+")");var data_temp=this._data_editor;this._option=option;this._isPosting=false;this._check_post_thread=null;this._maxMusicNum=10;this._elements={music_num:0,image_num:0,smiley_num:0,flash_num:0};this._reloadUrl="";this._event={};if(data_temp.is_readonly!=1&&data_temp.forbid_flag!=6){var tpl=$("#"+option.tpl_id)[0].innerHTML+"";this._generi_dom_id(option);var userInfo=option.userInfo;tpl=$.tb.format(tpl,this._dom_id);eidtor[0].innerHTML=tpl;this._compatibleOld();var domId=this._dom_id,op_temp=this._option;this._headInit(op_temp.header);var login=data_temp.is_login,can_post=data_temp.can_post,no_un=op_temp.no_un,forbid_flag=data_temp.forbid_flag;this._statInit(login,can_post,no_un,forbid_flag)}};RichPostor.prototype={constructor:RichPostor,_compatibleOld:function(){var e=this._option,d=this._dom_id;if(!e.page){if(e.title){this._option.page="frs";var c=$("#editor"),b=c.attr("class");if(b=="frs_rich_editor"){this._option.header="\u53d1\u8868\u65b0\u5e16"}else{this._option.header=""}}else{this._option.page="pb";this._option.header="\u53d1\u8868\u56de\u590d"}var a=$("#"+d.editor_banned_tip);a.css({top:"60px"});$("#"+d.reply_h).hide()}},_spamming:function(){$("body").append('<div id="anttongji" style="display:none"></div>');var a=$(document.createElement("script")),b="http://tongji.tieba.baidu.com/common/js/gettopic.js";a.attr({src:b,type:"text/javascript"});$("body").append(a)},_sendPamming:function(){var a=$.cookie("GET_TOPIC");if(a&&a==PageData.user.id){}else{this._spamming();$.cookie("GET_TOPIC",PageData.user.id,{expires:0.5,path:"/"})}},_headInit:function(c){var a=this,b=this._option;$("#"+b.editorDom).find(".editor_title_txt").html(c)},_statInit:function(b,e,c,d){var f=this._option,a=this;if(!b){this._cannotPost(f.page);this._showBannedTip(1);return}if(b&&e!=1){this._cannotPost(f.page);this._showBannedTip(2);return}if(b&&e==1&&c&&d>0){this._cannotPost(f.page);this._showBannedTip(3);return}if(this._option.is_block){this._cannotPost(f.page);this._showBannedTip("is_block");return}if(b&&e==1&&(!c&&d==0)){this._canPost(f.page);this._userBarInit(5);if(this._option.no_post_pic){a._editor.toolbar.disableInsertImage()}this._sendPamming();return}if(b&&e==1&&(c&&d==0)){this._canPost(f.page);this._userBarInit(4);a._editor.toolbar.disableInsertImage();this._sendPamming();return}if(b&&e==1&&(!c&&d>0)){this._canPost(f.page);this._userBarInit(5);if(this._option.no_post_pic){a._editor.toolbar.disableInsertImage()}this._sendPamming();return}},_cannotPost:function(a){if(a&&a.indexOf("frs")!=-1){this._titleInit("disable")}this._editorInit("disable");this._userBarInit(1);this._captchaInit();this._postBtnInit("disable");this._setContainerDisable()},_canPost:function(a){if(a&&a.indexOf("frs")!=-1){this._titleInit("enable")}this._editorInit("enable");this._captchaInit();this._postBtnInit("enable");this._showBannedTip(4)},_titleInit:function(b){var a=this;var d=this._dom_id;var e=this._option;switch(b){case"enable":$("#"+d.title_tr).show();var c=$("#"+e.title);c.focus(function(){$(this).addClass("edit_field_focus");a._initCaptchaAndSign(a)});c.blur(function(){$(this).removeClass("edit_field_focus")});c.keydown(function(g){var h=g||window.event;if(h.keyCode==13){a._editor.focus();return false}var f=a._limitTitle(h,this);return f});c.bind("input",function(){var f=this.value;if(f.getByteLength()==60){return false}if(f.getByteLength()>60){this.value=f.subByte(60)}return true});c.bind("propertychange",function(){var f=this.value;if(f.getByteLength()==60){return false}if(f.getByteLength()>60){this.value=f.subByte(60)}return true});break;case"disable":this._setDisable(a._option.title,true);$("#"+d.title_tr).show();break}},_editorInit:function(e){var f=this._dom_id,d=this._option,a=d.userInfo,b=this;var c={container:f.editorInput,uid:a.user["id"],flashNumLimit:d.media_conf["flashLimite"],flashWhiteList:d.media_conf["flashWhiteList"],height:"193px",width:"633px",forum_name:this._data_postor.kw,forum_id:this._data_postor.fid,user_name:a.user_name,picasso:d.picasso,no_post_pic:d.no_post_pic,bavl:d.bavl,is_ipad:d.is_ipad};switch(e){case"enable":c.autoEnable=true;b._editor=new TED.Editor(c);b._editorEvent();break;case"disable":c.autoEnable=false;b._editor=new TED.Editor(c);break}},_editorEvent:function(){var j=this;var a=this._data_editor,f=this._option;var d=this._dom_id;var i=f.userInfo;if(!this._editor.isMobile){try{this._editor.addPlugin("autoheight",new TED.EditorPlugins.AutoHeightPlugin());this._editor.addPlugin("draft",new TED.EditorPlugins.SaveDraft(i.user["id"],this._data_postor.fid,this._data_postor.tid,f.isPb));this._editor.addPlugin("filtehtml",new TED.EditorPlugins.FilteHtmlPlugin(this._option.no_post_pic?false:true));this._editor.addPlugin("imageeditor",new TED.EditorPlugins.ImageEditor());var c=$("#"+d.add_post_submit);if(this._option.open_idisk){this._editor.addPlugin("idisk",new TED.EditorPlugins.IdiskPlugin(this._option.power_idisk,this._data_postor.fid,this._option.upload_max_length,this._option.upload_max_size));this._editor.on("idisk_upload_complete",function(e){var k=this.getPostorDataObj("files");k=k||[];k.push(e);this.setPostorDataObj("files",k)},this);this._editor.on("idisk_remove_file",function(l){var m=this.getPostorDataObj("files");if(!m){return}if(l.md5){for(var k=0,e=m.length;k<e;k++){if(m[k].path===l.path){m.splice(k,1);if(m.length===0){this.setPostorData("files",undefined)}else{this.setPostorDataObj("files",m)}return}}}},this);this._editor.on("idisk_uploading_start",function(){j._isPosting=true;c.attr("disabled",true);c.removeClass("subbtn_bg").addClass("subbtn_bg_banned");c.next().html("\u6b63\u5728\u4e0a\u4f20\u6587\u4ef6\uff0c\u8bf7\u7a0d\u5019...")},this);this._editor.on("idisk_uploading_stop",function(){j._isPosting=false;c.attr("disabled",false);c.removeClass("subbtn_bg_banned").addClass("subbtn_bg");c.next().html("Ctrl+Enter\u5feb\u6377\u53d1\u8868")},this)}this._editor.addPlugin("FontEdit",new TED.EditorPlugins.FontEditPlugin(f.c_sign_num));MousePwd.start(["tb-editor-wrapper"])}catch(h){}}this._editor.on("quote",function(e){this.setPostorData("quote_id",e)},this);this._editor.on("unquote",function(){this.setPostorData("quote_id",0)},this);var g=this._editor,b=g.editArea;this._editor.on("focus",function(){$(b).addClass("edit_field_focus");setTimeout(function(){j._initCaptchaAndSign(j)},0)});this._editor.on("click",function(){$(b).addClass("edit_field_focus");setTimeout(function(){j._initCaptchaAndSign(j)},0)});this._editor.on("blur",function(){$(b).removeClass("edit_field_focus")})},_tipConfig:{"40":"\u53d1\u5f20\u56fe\uff0c\u79c0\u4e00\u4e0b\u4f60\u5bb6\u4e61\u7684\u7f8e\u98df\uff01","24":"\u81ea\u7206\u5927\u8d5b\u706b\u62fc\u4e2d\uff0c\u53d1\u5f20\u9753\u7167\u79d2\u6740\u5979\u4eec!","1474277":"\u6562\u4e0d\u6562\u7ed9\u5927\u5bb6\u53d1\u4e00\u5f20\u73cd\u85cf\u5df2\u4e45\u7684\u56fe\u7247\uff01","318":"\u6562\u4e0d\u6562\u628a\u4f60\u7684\u684c\u9762\u53d1\u51fa\u6765\uff01","71":"\u53d1\u5f20\u56fe\uff0c\u6652\u6652\u4f602012\u7684\u8db3\u8ff9\uff01"},_postorTip:function(b){var e=this._data_postor.fid,d=this._tipConfig[e],a=$(this._editor.editArea),c=$.trim(a.text());if(d&&c==""&&b=="init"){a.html("<div style='color:#999;'>"+d+"</div>");return}if(d&&d==c){a.html("");return}},_captchaInit:function(){var c=this._dom_id,b=this._data_editor;var a={container:"#"+c.captcha_div,onInputFocus:function(g,f){var d=f.getInputValue();if(d!=""){f.hideErrorTip()}}};this._captcha=PostorCaptchaReq.getCaptchaInstance(a)},_userBarInit:function(h){var e=this._dom_id,f=$("#"+e.post_user),a=$("#"+e.post_login);var c=$("#"+e.post_anonym_con),j=this;var b=this._data_editor,i=b.forbid_flag;switch(h){case 1:f.hide();return;case 2:a.attr("checked",true);a.attr("disabled",false);a.click(function(){PostorCaptchaReq.isAnonymous=false;j._initCaptchaAndSign(j);j._captcha.changeContent("loginUser")});c.hide();var g=document.getElementById(e.msg_cannot_anonym);var d="\uff08"+this._tip[i][1]+"\uff09";g.innerHTML=d;break;case 3:a.click(function(){PostorCaptchaReq.isAnonymous=false;j._initCaptchaAndSign(j);j._captcha.changeContent("loginUser")});$("#"+e.post_anonym).click(function(){PostorCaptchaReq.isAnonymous=true;j._initCaptchaAndSign(j);j._captcha.changeContent("anonym");if(!j._option.no_post_pic){j.onClickAnonym()}});a.attr("checked",true);c.show();break;case 4:f.html('<td style="padding-top:5px" valign="top"></td> <td style="padding-top:5px">\u60a8\u8fd8\u6ca1\u6709\u7528\u6237\u540d\uff0c\u53ea\u80fd\u533f\u540d\u53d1\u8d34\u3002<a href="#" onclick="TbCom.process(\'User\',\'buildUnameFrame\',\'\u586b\u5199\u7528\u6237\u540d\',\' \');return false;">\u9a6c\u4e0a\u586b\u5199\u7528\u6237\u540d</a></td>');PostorCaptchaReq.isAnonymous=true;case 5:f.find(".pt_uname").html("");a.attr("checked",true);f.find("label").hide();break}f.show()},_userBarEvent:function(){},_signInit:function(){},_postBtnInit:function(c){var b=this,d=this._dom_id,a=$("#"+d.add_post_submit);switch(c){case"enable":a.attr("disabled",false);a.className="subbtn_bg";b._postBtnEvent();break;case"disable":a.attr("disabled",true);a.className="subbtn_bg_banned";break}},_postBtnEvent:function(){var d=this._dom_id,b=this,a=$("#"+d.add_post_submit),c=$("#"+d.post);a.mouseover(function(){$(this).attr("class","subbtn_bg_hover")});a.mouseout(function(){$(this).attr("class","subbtn_bg")});a.mousedown(function(){$(this).attr("class","subbtn_bg_active")});c.submit(function(){b._submit();return false});c.keydown(function(f){var g=f||window.event;if(g.ctrlKey&&g.keyCode==13){if(g.preventDefault){g.preventDefault()}else{g.returnValue=false}b._submit()}})},_tip:[[""],["","\u672c\u5427\u76ee\u524d\u4ec5\u9650\u767b\u5f55\u7528\u6237\u53d1\u8d34\uff0c\u4e0d\u80fd\u4f7f\u7528\u533f\u540d\u53d1\u8d34\u529f\u80fd"],["\u62b1\u6b49\uff0c\u672c\u5427\u76ee\u524d\u4ec5\u9650\u5427\u52a1\u56e2\u961f\u53ca\u6ce8\u518c\u6ee1\u4e00\u5b9a\u65f6\u95f4\u7684\u8001\u7528\u6237\u53d1\u8d34","\u672c\u5427\u76ee\u524d\u4ec5\u9650\u5427\u52a1\u56e2\u961f\u53ca\u6ce8\u518c\u6ee1\u4e00\u5b9a\u65f6\u95f4\u7684\u8001\u7528\u6237\u53d1\u8d34\uff0c\u4e0d\u80fd\u4f7f\u7528\u533f\u540d\u53d1\u8d34\u529f\u80fd"],["\u62b1\u6b49\uff0c\u6839\u636e\u76f8\u5173\u6cd5\u5f8b\u6cd5\u89c4\u548c\u653f\u7b56\uff0c\u672c\u5427\u76ee\u524d\u4ec5\u5141\u8bb8","\u672c\u5427\u76ee\u524d\u4ec5\u9650\u4f1a\u5458\u53d1\u8d34\uff0c\u4e0d\u80fd\u4f7f\u7528\u533f\u540d\u53d1\u8d34\u529f\u80fd"],["\u62b1\u6b49\uff0c\u672c\u5427\u76ee\u524d\u4ec5\u9650\u5427\u52a1\u56e2\u961f\u53d1\u8d34","\u672c\u5427\u76ee\u524d\u4ec5\u9650\u5427\u52a1\u56e2\u961f\u53d1\u8d34\uff0c\u4e0d\u80fd\u4f7f\u7528\u533f\u540d\u53d1\u8d34\u529f\u80fd"],["\u62b1\u6b49\uff0c\u6839\u636e\u76f8\u5173\u6cd5\u5f8b\u6cd5\u89c4\u548c\u653f\u7b56\uff0c\u672c\u5427\u76ee\u524d\u53ea\u80fd\u6d4f\u89c8\uff0c\u4e0d\u80fd\u53d1\u8d34","\u62b1\u6b49\uff0c\u6839\u636e\u76f8\u5173\u6cd5\u5f8b\u6cd5\u89c4\u548c\u653f\u7b56\uff0c\u672c\u5427\u76ee\u524d\u53ea\u80fd\u6d4f\u89c8\uff0c\u4e0d\u80fd\u53d1\u8d34"]],_showBannedTip:function(g){var f=null;var c=this._dom_id,a=this._data_editor;var e=this._option,k=a.forbid_flag;var b="",f=document.getElementById(c.editor_banned_tip);switch(g){case 1:b='<div class="editor_banned_tip_info">'+this._tip[k][0];b=b+(k==1?"":"<br />");var l="<a href=\"#\" onclick=\"$.stats.sendRequest('fr=tb0_forum&st_mod=editor&st_type=count_action&st_value=login');_.Module.use('common/component/LoginDialog', ['', 'editor"+(PageData.page_id||"")+"']);return false;\">\u767b\u5f55</a> | <a href=\"#\" onclick=\"$.stats.sendRequest('fr=tb0_forum&st_mod=editor&st_type=count_action&st_value=reg');TbCom.process('User','buildRegisterFrame',null,null,null,'editor"+(PageData.page_id||"")+"');return false;\">\u6ce8\u518c</a>&nbsp;";b=b+(k==1?"\u672c\u5427\u53d1\u8d34\uff0c\u8bf7\u5148 ":"\u4f60\u53ef\u4ee5\u5148 ")+l;b+="</div>";break;case 2:b='<div class="editor_banned_tip_info">'+this._tip[k][0];var j='<a href="http://tieba.baidu.com/f/like/level?kw=d8" >4\u7ea7\u5934\u8854</a><br />\u4ee5\u4e0a\u4f1a\u5458\u53d1\u8d34\u3002';b=b+(k==3?j:"");b+="</div>";break;case 3:b="<div class=\"editor_banned_tip_info\">\u60a8\u8fd8\u6ca1\u6709\u7528\u6237\u540d\uff0c\u4e0d\u80fd\u5728\u672c\u5427\u53d1\u8d34\u3002\u8bf7\u5148<a href=\"#\" onclick=\"TbCom.process('User','buildUnameFrame','\u586b\u5199\u7528\u6237\u540d',' ');return false;\">\u586b\u5199\u7528\u6237\u540d</a></div>";break;case 4:if(f!=null){f.style.display="none"}break;case"is_block":var h=['<div class="editor_banned_tip_info">'];for(var d=1;d<4;d++){h.push($("#rich_postor_blocktippart"+d).html())}h.push("</div>");b=h.join("");b=b.replace(/(href=\")(.*?)(\")/,"$1$2"+this._data_postor.fid+"$3");break}if(f){f.innerHTML=b}},_setContainerDisable:function(){$("#editor").find("td").css("color","#CCCCCC")},jumpToTry:function(d){var c=this._data_editor;if(c.is_login&&c.can_post==1){var b=this._editor.toolbar;var a=this._editor.overlay;if(d==6){this._editor.jumpTo_picasso()}else{a.open("120px","43px","420px","355px","123px",this._editor.config.rootPath+"smiley.html?id="+this._editor.id+"&bavl=true")}}},_generi_dom_id:function(a){var b=new Date().valueOf();this._dom_id={post:"pt"+b,editor_banned_tip:"ebt"+b,editorInput:"eInput"+b,coError:"co"+b,post_login:"pl"+b,post_user:"pu"+b,post_anonym_con:"pac"+b,post_anonym:"pa"+b,msg_cannot_anonym:"mca"+b,signPanel:"sp"+b,captcha_container:"cc"+b,captcha_div:"cd"+b,add_post_submit:"aps"+b,uname:a.userInfo["user_name"],title_tr:"tt"+b,title_div:"td"+b,reply_h:"rh"+b,tiError:"tE"+b};if(a.title){this._dom_id.title=a.title}else{this._dom_id.title="title"}},_limitTitle:function(g,e){var b=[8,9,16,17,18,20,13,27,37,38,39,40,33,34,35,36,45,46,112,113,114,115,116,117,118,119,120,121,122,123,144,145];var f=g;var a=-1;for(var d=0;d<b.length;d++){if(b[d]==f.keyCode){a=d;break}}if(a>=0){return true}var c=e.value.toString();if(f.ctrlKey||f.altKey){return true}if(c.getByteLength()==60){return false}if(c.getByteLength()>60){e.value=c.subByte(60)}return true},bind:function(b,a,c){var d={stat:c?true:false,fun:a};if(this._event[b]){this._event[b].push(d)}else{this._event[b]=[];this._event[b].push(d)}},triggerEvent:function(b){var a=Array.prototype.slice.call(arguments,0);a.shift();if(this._event[b]){var d=this._event[b];for(var c=0;c<d.length;c++){if(d[c].fun){d[c].fun.apply(this,a)}if(!d[c].stat){return false}}}return true},reply:function(a,b,e){var d=this._data_editor;var c=this._option;if(d.can_post!=1){return false}else{if(c.no_un&&d.forbid_flag>0){return false}}this._editor.quote(a,b,e);if(PageData.is_last_page&&PageData.is_lzl==0){$.stats.sendRequest("fr=tb0_forum&st_mod=pb&st_type=quote&st_value=rp_reply")}},_isExist:function(a){if(!a){return false}var b=document.getElementById(a);if(b){return true}return false},_initCaptchaAndSign:function(a){var e=a._dom_id;var g=document.getElementById(e.post_login);var c=this._option;var d=this._data_editor;if(this._isExist(e.signPanel)){if(d.is_login){if(!c.no_un){if(g.checked){document.getElementById(e.signPanel).style.display="";SignNameApply.fillPanelId=e.signPanel;SignNameApply.active()}else{var b=document.getElementById(e.signPanel);if(b){b.style.display="none"}}}}else{var b=document.getElementById(e.signPanel);if(b){b.style.display="none"}}}var f=function(){if(PostorCaptchaReq.needCaptcha){a._captcha.show();$("#"+e.captcha_container).show()}else{a._captcha.hide();$("#"+e.captcha_container).hide()}};PostorCaptchaReq.antiProcess(f)},_setDisable:function(b,c){var a=document.getElementById(b);if(!a){return}a.disabled=true;if(c){$("#"+b).addClass("notPostbg")}},_checkPostStatus:function(){var a=this;this._stopCheckPostStatus();this._check_post_thread=setTimeout(function(){var b=document.getElementById(a._dom_id.add_post_submit);if(b&&b.disabled){$.stats.sendRequest("st_mod=editor&fr=tb0_forum&st_type=add_post")}},10*1000)},_stopCheckPostStatus:function(){var a=this;if(a._check_post_thread){clearTimeout(a._check_post_thread)}},_doInputCount:function(){var b=this._editor;var a={music_num:b.getMusicNum(),image_num:b.getImageNum(),smiley_num:b.getSmileyNum(),flash_num:b.getFlashNum()};$.stats.sendRequest("st_mod=editor&fr=tb0_forum&st_type=count_input&num_music="+a.music_num+"&num_image="+a.image_num+"&num_smiley="+a.smiley_num+"&num_flash="+a.flash_num+"&page_id="+PageData.page_id+((PageData.is_last_page&&PageData.is_lzl==0)?"&last_page=1":""));this._elements=a},setPostorData:function(a,c){var b=this._data_postor;b[a]=c},getPostorData:function(a){var b=this._data_postor;return b[a]},setPostorDataObj:function(a,c){var b=this._data_postor;b[a]=$.json.encode(c)},getPostorDataObj:function(a){var b=this._data_postor;return $.json.decode(b[a])},_getData:function(){var f=this._data_postor;var k=this._data_editor;var d=this._dom_id;var g=this._option;if(g.page!="pb"){f.title=$("#"+g.title).val().replace(/\u2006/g,"")}else{f.lp_type=g.thread_topic_type;f.lp_sub_type=g.thread_topic_subtype}var p=$("#"+g.editorDom),c=p.find(".BDE_Flash"),a=[],m=[];c.each(function(){var e=this,q=$(this),s=q.attr("data-video_url"),r=q.attr("video_mp4_url");if(s){a.push(s)}if(r){m.push(r)}});if(a.length>0){f.video_url=a.join(",")}if(m.length>0){f.video_mp4_url=m.join(",")}f.content=this._editor.getHtml();var h=k.is_login;var o=document.getElementById("useSignName");var b=document.getElementById(d.post_login);var j=document.getElementById("sign_id");if(!g.no_un&&h){if(b.checked&&o&&o.checked&&j){f.sign_id=j.value}}if(h){if(!g.no_un){f.anonymous=0}else{f.anonymous=1}}f.tbs=this._option.tbs;var l=this._captcha.getInputValue();if(l!=""){f.vcode=l}f.vcode_md5=this._captcha.signStr;try{var n=window.external.GetVersion("version");if(n.indexOf("baidubrowser")>-1){f.browser_version="baidubrowser"}}catch(i){}return f},getEditor:function(){return this._editor},_validator:function(){if(this._option.title){var a=this._data_editor;if((!a.is_notitle)&&!this._validFrsPostTitle()){return false}}else{var c=this._dom_id;var b=document.getElementById(c.coError);if(this._editor.isEmpty()){b.style.display="";b.innerHTML="\u56de\u590d\u5185\u5bb9\u4e0d\u80fd\u4e3a\u7a7a";b.className="postErrorContent";this._editor.focus();return false}}if(!this._validRichEditorContent()){return false}if(!this._captcha.validCaptcha()){return false}return true},_validRichEditorContent:function(){var c=this._dom_id,o=this;var m=this._data_editor;var b=document.getElementById(c.coError);var g=this._option.media_conf;var h=this._option;if(m.is_notitle){if($("#"+h.title).val().trim()==h.newTitieField_tip||$("#"+h.title).val().trim()==""){this.setPostorData("tfrom",2);$("#"+h.title).val("");if((this._editor.isEmpty()||!this._editor.getHtml().replace(/<[^>]*>|(&nbsp;)|[\s\u3000]*/g,""))){b.style.display="";b.innerHTML="\u53d1\u8d34\u5185\u5bb9\u9700\u5305\u542b\u6587\u5b57";this._editor.focus();return false}}}var a=this._editor.getImageNum();if(a>g.imageLimite){b.style.display="";b.innerHTML="\u62b1\u6b49\uff0c\u6bcf\u5c42\u697c\u63d2\u5165\u7684\u56fe\u7247\u4e0d\u80fd\u8d85\u8fc7"+g.imageLimite+"\u5f20\uff0c\u8bf7\u4fee\u6539\u540e\u91cd\u65b0\u63d0\u4ea4";this._editor.focus();return false}var d=this._editor.getFlashNum();if(d>g.flashLimite){b.style.display="";b.innerHTML="\u62b1\u6b49\uff0c\u6bcf\u5c42\u697c\u63d2\u5165\u7684\u89c6\u9891\u4e0d\u80fd\u8d85\u8fc7"+g.flashLimite+"\u4e2a\uff0c\u8bf7\u4fee\u6539\u540e\u91cd\u65b0\u63d0\u4ea4";this._editor.focus();return false}var f=this._editor.getSmileyNum();if(f>g.smileyLimite){b.style.display="";b.innerHTML="\u62b1\u6b49\uff0c\u6bcf\u5c42\u697c\u63d2\u5165\u7684\u8868\u60c5\u4e0d\u80fd\u8d85\u8fc7"+g.smileyLimite+"\u4e2a\uff0c\u8bf7\u4fee\u6539\u540e\u91cd\u65b0\u63d0\u4ea4";this._editor.focus();return false}var n=this._editor.getMusicNum();if(n>this._maxMusicNum){b.style.display="";b.innerHTML="\u62b1\u6b49\uff0c\u6bcf\u5c42\u697c\u63d2\u5165\u7684\u97f3\u4e50\u6570\u4e0d\u80fd\u8d85\u8fc7"+this._maxMusicNum+"\u4e2a\uff0c\u8bf7\u4fee\u6539\u540e\u91cd\u65b0\u63d0\u4ea4";this._editor.focus();return false}try{var k=this._editor.editArea,l="";if($.browser.msie){l=k.innerText}else{l=k.textContent}var i=l.getByteLength();if(i>10000){var p="\u62b1\u6b49\uff0c\u60a8\u7684\u8d34\u5b50\u8d85\u8fc75000\u5b57\uff0c\u5efa\u8bae\u60a8\u7cbe\u7b80\u6216\u5206\u6bb5\u540e\u518d\u63d0\u4ea4";o._errorTipShow(p);return false}}catch(j){}return true},_errorTipShow:function(c){var d=this._dom_id,a=this;var b=document.getElementById(d.coError);b.style.display="";b.innerHTML=c;this._editor.focus()},_validFrsPostTitle:function(){var b=this._dom_id;var a=document.getElementById(b.title);if(a.value.trim()==""){$("#"+b.tiError).html("\u6807\u9898\u4e0d\u80fd\u4e3a\u7a7a").show();a.focus();return false}else{$("#"+b.tiError).hide()}return true},_submit:function(){if(PageData.page_id===1&&PageData.thread.is_ad===1){if(document.images){var g=new Image();g.src=PageData.ecomStatDomain+"reply.php?forumid="+(PageData.forum_id||"")+"&tid="+(PageData.thread.id||"")+"&userid="+(PageData.user.id||"")+"&username="+encodeURIComponent(PageData.user_name||"")+"&exp="+encodeURIComponent(PageData.ecomExp||"")+"&t="+new Date().getTime();g=null}}if(this._isPosting){return}try{var h=this;var d=this._dom_id;var k=document.getElementById(d.captcha_container);var c=document.getElementById(d.signPanel);if(k.style.display=="none"&&c.style.display=="none"){h._initCaptchaAndSign(h)}}catch(i){}if(this._validator()){this._isPosting=true;var d=this._dom_id;document.getElementById(d.add_post_submit).disabled=true;document.getElementById(d.add_post_submit).className="subbtn_bg_banned";this._checkPostStatus();var a=this._option.url;var b=MousePwd.report();var j=MousePwd.time;var m=MOUSEPWD_CLICK;this.setPostorData("mouse_pwd",b.c);this.setPostorData("mouse_pwd_t",j);this.setPostorData("mouse_pwd_isclick",m);var f=this._getData();var l=this;PostHandler.post(a,f,function(e){$.cookie("GET_TOPIC","-",{expires:-1,path:"/"});l.showAddResult(e)},function(e){Statistics.sendRequest("st_mod=editor&fr=tb0_forum&st_type=add_post_error&e_text="+encodeURIComponent(e?e.status:""))});return}},onClickAnonym:function(){var a=this;if(a.isAnonymState){return}a.isAnonymState=true;var b=a._editor.editorPlugins.draft;if(!a.notFirstTimeHere){$("#"+a._dom_id.post_login).click(function(){if(a.isAnonymState){a._editor.toolbar.enableInsertImage();a.isAnonymState=false;if(b&&b.tip.holder.innerHTML.charAt(0)==="<"){b.tip.holder.innerHTML=""}}});a.notFirstTimeHere=true}a._editor.toolbar.disableInsertImage();if(a._editor.getImageNum()>0&&b){b.tip.holder.style.display="block";b.tip.holder.innerHTML='<span style="color:red">\u533f\u540d\u72b6\u6001\u4e0b\uff0c\u5185\u5bb9\u542b\u6709\u56fe\u7247\u5c06\u65e0\u6cd5\u53d1\u8868\u6210\u529f\uff0c\u8bf7\u5207\u6362\u5230\u975e\u533f\u540d\u72b6\u6001</span>'}},_postSuccess:function(){var d=this._dom_id,e=$("#"+d.editor_banned_tip),b="",a=this._editor,c=a.editArea;e.css({top:"120px",left:"250px"});$(c).css({backgroundColor:"#F7F7F7"});if(this._editor.empty){this._editor.empty()}b+='<div class="editor_banned_tip_info"><span class="postor_success"></span><span style="font-weight:bold;">\u53d1\u8868\u6210\u529f\uff01</span></div>';e.html(b);e.show()},_showErrorTip:function(a,d){var b='<div style="margin: 0px 30px 0px 30px;font-size:14px;line-height:20px;text-align:left;font-family: "\u5b8b\u4f53";"><table style="width:90%"><tbody><tr><td width="60">'+a.image+'</td><td valign="middle" style="font-size:20px;line-height:22px;font-family: "\u9ed1\u4f53";">'+a.subMessage+"</td></tr></tbody></table>"+a.message+"</div>";var c=$.dialog.alert(b,a.dialogSet);c.bind("onclose",d)},showAddResult:function(m){this._stopCheckPostStatus();var c=this._dom_id;var n=this;var j=null;var h=function(p){switch(p.getActionType()){case p.Action_FocusTitle:try{var s=c.title;var q=document.getElementById(s);if(q){q.focus();q.value=q.value}}catch(r){}break;case p.Action_FocusContent:n._editor.focus();break;case p.Action_ClearYZM:if(n._captcha){n._captcha.clear();n._captcha.focus();n._captcha.reload()}break;case p.Action_GoToHead:document.location.hash="pgTop";break;case p.Action_FlushAndGoToHead:n._postSuccess();setTimeout(function(){var e=n.triggerEvent("onsuccess",p);if(!e){return}document.location.href=n._reloadUrl||document.location.href.split("#")[0]},800);break;default:break}};var k=null;try{k=m;Thread_add_result.init(k)}catch(g){var i=g+"___";try{i+=m.responseText;i=i.substring(0,100)}catch(g){}$.stats.sendRequest("st_mod=editor&fr=tb0_forum&st_type=add_post_json_error&e_text="+encodeURIComponent(i))}var l=Thread_add_result.resultNo;if(l==0){var a=500;n._doInputCount();setTimeout(function(){h(Thread_add_result)},a)}else{if(Thread_add_result.isNeedWaitForCheck()){n._doInputCount();var o=Thread_add_result.getMessage();var d={image:'<img style="border:none;" src="http://static.tieba.baidu.com/tb/img/messageFace.gif">',subMessage:"\u7b49\u5f85\u5ba1\u6838...",message:o,dialogSet:{width:380,height:105,title:"\u53d1\u8868\u8d34\u5b50"}};n._showErrorTip(d,function(){h(Thread_add_result);document.getElementById(c.add_post_submit).disabled=false;document.getElementById(c.add_post_submit).className="subbtn_bg";n._isPosting=false;window.location.reload();return true})}else{if(Thread_add_result.isNeedBindPhone()){n._doInputCount();if(TED.Storage.isSupport()){n._editor.editorPlugins.draft.set()}var f=$.dialog.alert("<div style='margin: 15px;'>"+Thread_add_result.getMessage()+"</div>",{title:"\u53d1\u8d34\u5931\u8d25",acceptValue:"\u7ed1\u5b9a\u624b\u673a",width:410,onaccept:function(){var e=location.href;if(e.indexOf("#")!=-1){e=e.substring(0,e.lastIndexOf("#"))}location.href="http://passport.baidu.com/v2/?accountbindphone&tpl=tb&u="+encodeURIComponent(e+"#sub");return false},onclose:function(){var e=document.getElementById(c.add_post_submit);e.disabled=false;e.className="subbtn_bg";n._isPosting=false}})}else{var o=Thread_add_result.getMessage();if(l==40){n._captcha.showErrorTip(o);n._captcha.clear();n._captcha.focus();n._captcha.reload();var b=$("#"+c.add_post_submit);b.attr("disabled",false);b.removeClass("subbtn_bg_banned").addClass("subbtn_bg");n._isPosting=false}else{var d={image:'<img style="border:none;" src="http://static.tieba.baidu.com/tb/img/errorFace.gif">',subMessage:"\u53d1\u8d34\u5931\u8d25",message:o,dialogSet:{width:410,height:95,title:"\u53d1\u8868\u8d34\u5b50"}};n._showErrorTip(d,function(){h(Thread_add_result);document.getElementById(c.add_post_submit).disabled=false;document.getElementById(c.add_post_submit).className="subbtn_bg";n._isPosting=false;return true})}}}}}};